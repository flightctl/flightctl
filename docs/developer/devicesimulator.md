# Device Simulator

`devicesimulator` is used to simulate the load generated by devices. It launches independent instances of 
the flightctl-agent process with configurable concurrency, retry mechanisms, and monitoring capabilities. 

The simulator automatically handles device enrollment, fleet assignment, and provides comprehensive metrics for performance testing. Various portions of a device's spec can cause issues should you try to update them (os image, applications).

### Setup

Copy the necessary setup files to run a `devicesimulator`.

    mkdir -p ~/.flightctl/certs/ ~/.config/flightctl/
    cp bin/agent/etc/flightctl/certs/* ~/.flightctl/certs/
    cp bin/agent/etc/flightctl/config.yaml ~/.flightctl/agent.yaml

Changes to the configuration of all launched agents can be made in `~/.flightctl/agent.yaml`
Some key options available for tuning:
- `spec-fetch-interval` - Affects how often the agent queries the API. Higher intervals reduce load on the server.
- `status-update-interval` - Affects how often the agent queries the API. Higher intervals reduce load on the server.
- `system-info` - Affects what system info each agent collects. Recommended to set this to nothing: `[]`

See [Configuring Agent](../user/configuring-agent.md) for all available options.

## CLI Reference

The device simulator supports various command-line options organized into logical groups:

### Device Configuration
- `--count` (default: 1): Number of devices to simulate
- `--initial-device-index` (default: 0): Starting index for device name suffix (e.g., device-00000 for 0, device-00200 for 200)
- `--label`: Label applied to simulated devices in the format key=value (can be specified multiple times)

### Concurrency and Retry Configuration
- `--max-concurrency` (default: 50): Maximum number of agents that can be creating simultaneously
- `--max-retries` (default: 3): Maximum number of retry attempts for failed device creation
- `--retry-delay` (default: 10s): Base delay between retry attempts

### Runtime Configuration
- `--stop-after`: Stop the simulator after the specified duration (format: 1h30m, 5m, etc.)
- `--log-level, -v` (default: debug): Logger verbosity level (fatal, error, warn, warning, info, debug)
- `--metrics` (default: localhost:9093): Address for the metrics endpoint

### File and Directory Configuration
- `--config` (default: ~/.flightctl/agent.yaml): Path of the agent configuration template
- `--data-dir` (default: ~/.flightctl/data): Directory for storing simulator data

### Output Configuration
- `--output, -o`: Output format for version command (json, yaml)

### Commands
- `version`: Print device simulator version information
- `help`: Show help message

#### Version Command Examples

```bash
# Default text output
bin/devicesimulator version

# JSON output
bin/devicesimulator version --output=json

# YAML output  
bin/devicesimulator version --output=yaml
```

### Examples

```bash
# Basic usage - simulate 1 device
bin/devicesimulator

# Simulate 100 devices with custom labels
bin/devicesimulator --count=100 --label="environment=test" --label="region=us-east"

# Performance testing with high concurrency
bin/devicesimulator --count=1000 --max-concurrency=100 --log-level=error

# Distributed simulation starting at device index 500
bin/devicesimulator --count=200 --initial-device-index=500

# Time-limited simulation with custom retry settings
bin/devicesimulator --count=50 --stop-after=1h --max-retries=5 --retry-delay=5s
```

## Configuration

### Agent Configuration Template

The simulator uses an agent configuration template (`~/.flightctl/agent.yaml` by default) that is applied to all simulated devices. This template is copied and customized for each agent instance.

Key configuration parameters that affect simulator performance:

- `spec-fetch-interval`: How often agents check for spec updates (default from template)
- `status-update-interval`: How often agents report status (default from template)
- `log-level`: Inherited from simulator's `--log-level` flag

### Device Naming

Devices are named using the format `device-XXXXX` where XXXXX is a zero-padded 5-digit number starting from the `--initial-device-index` value.

### Retry and Backoff Configuration

The simulator implements exponential backoff for failed device creation attempts:
- Base delay: Configurable with `--retry-delay`
- Backoff factor: 2.0
- Jitter: 10% to avoid thundering herd
- Max attempts: `--max-retries` + 1

Today the agent assumes a bootc host so the default disk alerts are based on /sysroot path.
To avoid many errors in the logs as a result of being unable to read from `/sysroot` consider either:
1. Create the empty directory `sudo mkdir /sysroot`
2. Create a fleet with a disk alert with the path `/` and assign all created devices to that fleet
 
### Limits

The number of devices runnable on a single host is determined by the resources available to the host and what each
device is configured to do.

It is possible to run 10k devices on a single instance running the flightctl services and the simulator provided proper system tuning is applied.

#### Performance Tuning Recommendations

1. **CPU Isolation**: Limit CPUs available to the simulator to ensure resources for flightctl services:
   ```bash
   taskset -c 0-7 bin/devicesimulator --count 10000
   ```

2. **Avoid Applications**: Don't assign applications to simulated devices. Applications trigger `podman events` processes that consume significant CPU and reduce scalability.

3. **Tune Agent Intervals**: Increase intervals in `~/.flightctl/agent.yaml` to reduce API load:
   ```yaml
   spec-fetch-interval: 60s    
   status-update-interval: 60s 
   ```

4. **Optimize Logging**: Use higher log levels to reduce I/O overhead:
   ```bash
   bin/devicesimulator --log-level=error --count 10000
   ```

5. **Concurrency Control**: Tune simulator concurrency based on system capacity:
   ```bash
   # For systems with limited resources
   bin/devicesimulator --max-concurrency=25 --max-retries=5 --retry-delay=15s
   
   # For high-performance systems  
   bin/devicesimulator --max-concurrency=100 --max-retries=3 --retry-delay=5s
   ```

6. **Disable System Info Collection**: Set system-info to empty array in agent config:
   ```yaml
   system-info: []
   ```

### System-level Connection Limits

When simulating a large number of devices, each running agent establishes multiple HTTP connections to the flightctl server. This can exhaust system resources related to network connections. Understanding these limits is crucial for large-scale simulations.

*   **File Descriptors and `ulimit`**: On Linux and other Unix-like systems, every network connection is treated as a file descriptor. Each process has a limit on the number of file descriptors it can have open simultaneously. You can check the current limit for your shell session with `ulimit -n`. This is often a soft limit that can be increased. If a process tries to open more file descriptors than its limit, it will fail, leading to connection errors. You can increase the soft limit for the simulator's session, but you might also need to adjust the hard limit.

*   **Hard Limits**: The hard limit is the maximum value to which a soft limit can be raised. It's a system-wide configuration that prevents any single user or process from consuming all available resources. Modifying hard limits usually requires root privileges and involves editing files like `/etc/security/limits.conf`.

*   **Ephemeral Ports**: When a client (like a flightctl agent) connects to a server, it is assigned a temporary (or ephemeral) port from a specific range. The operating system has a finite number of these ports available. Once this range is exhausted, no new outgoing connections can be made, and you'll see "address already in use" errors. You can view the ephemeral port range on a Linux system with `sysctl net.ipv4.ip_local_port_range`. While this range can be adjusted, it represents a hard ceiling on the number of simultaneous connections from a single IP address.

In addition to the file descriptors opened by agent HTTP connections, agents also open many more traditional files for various purposes (persistence, system details, .etc).

When running the device simulator, you may need to tune these system parameters to support a high number of concurrent agents.


### Running

```sh
    bin/devicesimulator --count=1
```

#### Automatic Fleet Creation

The device simulator automatically creates a fleet configuration named `simulator-disk-monitoring` if it doesn't already exist. This fleet:
- Eliminates disk usage errors that would occur with default monitoring configurations
- Uses the selector `created_by: device-simulator` to automatically match all devices created by the simulator
- Loads configuration from `examples/fleet-disk-simulator.yaml`
- Provides appropriate disk monitoring settings for simulated devices

All devices created by the simulator are automatically labeled with `created_by: device-simulator`, ensuring they are matched by this fleet without manual intervention.

#### Device Enrollment Process

The simulator handles the complete device lifecycle:
1. Creates agent instances with unique device names (format: device-XXXXX)
2. Starts agent processes that initiate enrollment requests
3. Automatically approves enrollment requests when they appear
4. Applies configured labels to enrolled devices
5. Manages concurrent device creation with configurable limits and retry logic

## Monitoring

The device simulator provides metrics through a built-in HTTP endpoint for monitoring performance and tracking device states.

### Metrics Endpoint

By default, metrics are exposed on `localhost:9093`. You can customize this with the `--metrics` flag:

```bash
bin/devicesimulator --metrics="0.0.0.0:8080" --count=100
```

### Available Metrics

The simulator tracks various metrics including:
- Number of active agents
- Device creation success/failure rates
- Enrollment completion times
- Agent process lifecycle events

These metrics can be scraped by monitoring systems like Prometheus for observability during large-scale testing.

### Configuration

The metrics endpoint is automatically configured when the simulator starts. No additional setup is required, but ensure the metrics port is accessible if running on remote hosts or in containerized environments.

# Remote simulator

To simulate a large number of devices (10,000 for example) a
`devicesimulator` has to be installed on a number of separate hosts to let it use more resources. Each remote host must be [set up](#remote-setup) with the same files. Then you have to [start simulator](#remote-run) on each host.

### Remote setup

Run the same commands per each host. Note: some commands must be run remotely.

```sh
    # on remote host
    mkdir -p ~/.flightctl/certs/ ~/.config/flightctl ~/bin
    scp bin/agent/etc/flightctl/certs/* your_username@remotehost:~/.flightctl/certs/
    scp bin/agent/etc/flightctl/config.yaml your_username@remotehost:~/.flightctl/agent.yaml
    scp ~/.config/flightctl/client.yaml your_username@remotehost:~/.config/flightctl/client.yaml
    scp bin/devicesimulator your_username@remotehost:~/bin/
    # on remote host 
    chmod -R 755 ~/.flightctl/ ~/.config/flightctl ~/bin/devicesimulator
```

### Remote run

On each remote host run `devicesimulator` with at least two parameters:
* count - number of devices to simulate on this host
* initial-device-index - starting index for device name suffix. To simulate 600 devices on 3 hosts run:
    > bin/devicesimulator --count=200 \# device-00000 to device-00199
    > 
    > bin/devicesimulator --count=200 --initial-device-index=200 \# device-00200 to device-00399
    > 
    > bin/devicesimulator --count=200 --initial-device-index=400 \# device-00400 to device-00599

When running remotely it is important to consider [connection limits](devicesimulator.md#system-level-connection-limits) when running large scale performance tests.

## Troubleshooting

### Common Issues

#### Device Creation Failures
- **Symptom**: Devices fail to enroll after multiple retries
- **Solution**: Check enrollment service connectivity and certificate validity. Increase `--max-retries` and `--retry-delay` for unstable networks.

#### High Resource Usage
- **Symptom**: High CPU/memory usage during simulation
- **Solution**: 
  - Reduce `--max-concurrency` to limit parallel device creation
  - Increase agent intervals (`spec-fetch-interval`, `status-update-interval`) in agent config
  - Use higher log levels (`--log-level=error` or `--log-level=fatal`)

#### Connection Limits
- **Symptom**: "Too many open files" or "Address already in use" errors
- **Solution**: 
  - Increase file descriptor limits: `ulimit -n 65536`
  - Tune ephemeral port range: `sysctl net.ipv4.ip_local_port_range`
  - Distribute load across multiple hosts

#### `/sysroot` Errors
- **Symptom**: Repeated errors about unable to read `/sysroot`
- **Solution**: 
  - Create empty directory: `sudo mkdir /sysroot`
  - Or ensure the auto-created fleet has appropriate disk monitoring paths

### Performance Optimization

For large-scale testing (1000+ devices):
1. Use multiple hosts to distribute load
2. Limit CPU usage with `taskset`
3. Increase system limits (file descriptors, ephemeral ports)
4. Tune agent intervals to reduce API load
5. Use error-level logging to reduce I/O overhead

### Cleanup

Devices should clean themselves up on graceful exit (ctrl + c), but if they fail and the device previously had applications associated with it, some `podman events` processes could be lingering. If they are run the following:
```sh
    #!/bin/bash
    while true; do
      echo pkill -f -TERM 'podman events'
      sudo pkill -f -TERM 'podman events'
      sleep 30
    done
```

