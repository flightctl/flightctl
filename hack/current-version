#!/usr/bin/env bash

# Fix git ownership issue in CI environments
git config --global --add safe.directory /__w/flightctl/flightctl 2>/dev/null || true
git config --global --add safe.directory "$(pwd)" 2>/dev/null || true

# Prefer proper release tags pointing at this exact commit first, prioritizing the highest version
# tag. If there is no tag at this commit, then fallback to 'git describe' which will construct a
# "human-readable" artificial tag.
tag=$(git -c "versionsort.suffix=-rc" tag --points-at HEAD --sort version:refname -l 'v*' | tail -n 1 2>/dev/null)

if [[ -z "$tag" ]]; then
  tag=$(git describe --tags --always --first-parent --match 'v*' 2>/dev/null)
fi

if [[ -z "$tag" ]]; then
  echo "ERROR: Unable to generate tag from repo" >&2
  exit 1
fi

echo -n "$tag"
