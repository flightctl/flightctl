#!/usr/bin/env bash

# Fix git ownership issue in CI environments
git config --global --add safe.directory /__w/flightctl/flightctl 2>/dev/null || true
git config --global --add safe.directory "$(pwd)" 2>/dev/null || true

# Prefer proper release tags pointing at this exact commit first, prioritizing the highest version
# tag. If there is no tag at this commit, then fallback to 'git describe' which will construct a
# "human-readable" artificial tag.
tag=$(git -c "versionsort.suffix=-rc" tag --points-at HEAD --sort version:refname | tail -n 1 2>/dev/null)

if [[ -z "$tag" ]]; then
  tag=$(git describe --tags --exclude latest 2>/dev/null || echo -n "v0.0.0-unknown")
fi

# For RPM packaging (when called from packit), remove git commit hash but preserve main branch info
# since COPR will add its own commit information, preventing duplication
if [[ "${PACKIT_BUILD:-}" == "1" ]] || [[ "$1" == "--rpm" ]]; then
  # For main branch builds, preserve the "-main" part but remove commit details
  # Examples:
  #   v1.0.0-main-211-g1234567 -> v1.0.0-main
  #   v1.0.0-feature-123-g5678abc -> v1.0.0 (non-main branches get stripped completely)
  #   v1.0.0 -> v1.0.0 (release tags stay as-is)
  if [[ "$tag" =~ -main ]]; then
    # Keep base version and "-main" but remove commit details
    tag=$(echo "$tag" | sed 's/-main.*$/-main/')
  else
    # Remove everything after the base version for non-main branches
    tag=$(echo "$tag" | sed 's/-.*$//')
  fi
fi

echo -n "$tag"
