name: 'Deploy Backend with Helm'
description: |
  Complete deployment of FlightCtl backend to a kind cluster using Helm.
  
  Downloads artifacts (images, chart, CLI), creates kind cluster, loads images,
  and deploys using helm.

inputs:
  tag:
    description: 'Image tag for artifacts (if not provided, will be computed from git)'
    required: false
  base-domain:
    description: 'Base domain for the deployment'
    required: true
  namespace-external:
    description: 'External namespace for FlightCtl API components'
    required: false
    default: 'flightctl-external'
  namespace-internal:
    description: 'Internal namespace for FlightCtl backend components'
    required: false
    default: 'flightctl-internal'
  additional-values-files:
    description: 'Space-separated list of additional Helm values files to apply (paths relative to repo root)'
    required: false
    default: ''
  auth-type:
    description: 'Authentication type (empty for default, "k8s" for Kubernetes auth)'
    required: false
    default: ''
  kind-config:
    description: 'Path to kind cluster config file'
    required: false
    default: 'deploy/kind.yaml'
  display-summary:
    description: 'Whether to display deployment summary in GitHub step summary'
    required: false
    default: 'true'
  wait:
    description: 'Wait for deployment to complete (adds --wait --debug to helm install)'
    required: false
    default: 'true'

runs:
  using: "composite"
  steps:
    # ========== COMPUTE TAGS IF NOT PROVIDED ==========
    - name: Compute tags from git
      id: compute-tags-git
      if: inputs.tag == ''
      uses: ./.github/actions/compute-tag

    - name: Set git tag
      id: compute-tags
      shell: bash
      run: |
        set -euo pipefail
        
        if [ -n "${{ inputs.tag }}" ]; then
          echo "Using provided tag: ${{ inputs.tag }}"
          echo "git_tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
        else
          echo "Using computed git_tag: ${{ steps.compute-tags-git.outputs.git_tag }}"
          echo "git_tag=${{ steps.compute-tags-git.outputs.git_tag }}" >> "$GITHUB_OUTPUT"
        fi

    # ========== DOWNLOAD BACKEND ARTIFACTS ==========
    - name: Download backend images bundle
      uses: actions/download-artifact@v4
      with:
        name: flightctl-images-bundle-${{ steps.compute-tags.outputs.git_tag }}
        path: artifacts

    - name: Download helm chart
      uses: actions/download-artifact@v4
      with:
        name: helm-chart-${{ steps.compute-tags.outputs.git_tag }}
        path: artifacts

    - name: Download CLI binary
      uses: actions/download-artifact@v4
      with:
        name: flightctl-linux-amd64-${{ steps.compute-tags.outputs.git_tag }}
        path: artifacts

    - name: Setup CLI binary
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p bin
        mv artifacts/flightctl-linux-amd64 bin/flightctl
        chmod +x bin/flightctl
        echo "CLI binary ready at bin/flightctl"

    # ========== INITIALIZE KIND CLUSTER ==========
    - name: Create kind cluster
      shell: bash
      run: kind create cluster --config ${{ inputs.kind-config }}

    # ========== LOAD IMAGES INTO KIND ==========
    - name: Load backend images into kind
      shell: bash
      run: |
        set -euo pipefail
        echo "Loading backend service images into kind"
        kind load image-archive artifacts/flightctl-images-bundle.tar
        echo "Backend images loaded successfully"

    - name: Clean up backend bundle files
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Cleaning up backend bundle files"
        echo "Removing backend bundle (no longer needed after loading into kind)..."
        rm artifacts/flightctl-images-bundle.tar
        df -h
        echo "::endgroup::"

    # ========== DEPLOY BACKEND ==========
    - name: Deploy FlightCtl backend with Helm
      id: helm-deploy
      shell: bash
      env:
        BASE_DOMAIN: ${{ inputs.base-domain }}
        ADDITIONAL_VALUES_FILES: ${{ inputs.additional-values-files }}
        AUTH_TYPE: ${{ inputs.auth-type }}
        NAMESPACE_EXTERNAL: ${{ inputs.namespace-external }}
        NAMESPACE_INTERNAL: ${{ inputs.namespace-internal }}
        WAIT: ${{ inputs.wait }}
      run: |
        set -euo pipefail

        kubectl create namespace "${NAMESPACE_INTERNAL}"
        ( kubectl get pods --all-namespaces -w | sed 's/^/[cluster] /' ) &

        # Build optional args
        EXTRA_ARGS=""
        for f in ${ADDITIONAL_VALUES_FILES}; do [ -f "$f" ] && EXTRA_ARGS+=" --values $f"; done
        [ -n "${AUTH_TYPE}" ] && EXTRA_ARGS+=" --set global.auth.type=${AUTH_TYPE}"

        # Build the helm command
        HELM_CMD="helm install flightctl artifacts/flightctl-chart.tgz"
        HELM_CMD+=" --namespace ${NAMESPACE_EXTERNAL}"
        HELM_CMD+=" --create-namespace"
        HELM_CMD+=" --values deploy/helm/flightctl/values.nodeport.yaml"
        HELM_CMD+=' --set global.baseDomain="${BASE_DOMAIN}"'
        HELM_CMD+=" --set global.internalNamespace=${NAMESPACE_INTERNAL}"
        HELM_CMD+=" --set ui.enabled=false"
        HELM_CMD+="${EXTRA_ARGS}"

        if [ "${WAIT}" == "true" ]; then
          HELM_CMD+=" --wait"
        fi

        # Output command for summary (with literal ${BASE_DOMAIN} for local reproduction)
        {
          echo "helm_cmd<<EOF"
          echo "${HELM_CMD}"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

        # Execute with --debug for verbose output if waiting
        if [ "${WAIT}" == "true" ]; then
          eval "${HELM_CMD} --debug"
        else
          eval "${HELM_CMD}"
        fi

    - name: "Wait for API readiness"
      if: inputs.wait == 'true'
      uses: ./.github/actions/wait-for-api-readiness
      with:
        base-domain: ${{ inputs.base-domain }}

    - name: Generate deployment summary
      if: inputs.display-summary == 'true'
      shell: bash
      env:
        IMAGE_TAG: ${{ steps.compute-tags.outputs.git_tag }}
        NAMESPACE_INTERNAL: ${{ inputs.namespace-internal }}
        KIND_CONFIG: ${{ inputs.kind-config }}
        RUN_ID: ${{ github.run_id }}
        HELM_CMD: ${{ steps.helm-deploy.outputs.helm_cmd }}
      run: |
        set -euo pipefail
        
        {
          echo "### :rocket: Deployment"
          echo ""
          echo "Backend deployed successfully to kind cluster."
          echo ""
          echo "#### Reproduce Locally"
          echo ""
          echo '```bash'
          echo "# Download artifacts"
          echo "mkdir -p bin artifacts"
          echo "gh run download ${RUN_ID} -n flightctl-images-bundle-${IMAGE_TAG} -D bin"
          echo "gh run download ${RUN_ID} -n helm-chart-${IMAGE_TAG} -D artifacts"
          echo ""
          echo "# Create kind cluster and load images"
          echo "kind create cluster --config ${KIND_CONFIG}"
          echo "kind load image-archive bin/flightctl-images-bundle.tar"
          echo ""
          echo "# Deploy"
          echo 'source ./test/scripts/functions && export BASE_DOMAIN=$(get_ext_ip).nip.io'
          echo "kubectl create namespace ${NAMESPACE_INTERNAL}"
          echo "${HELM_CMD}"
          echo '```'
        } >> "$GITHUB_STEP_SUMMARY"
