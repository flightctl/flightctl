name: 'Deploy Backend with Helm'
description: 'Deploy FlightCtl backend using Helm'

inputs:
  tag:
    description: 'Image tag (if not provided, will be computed from git)'
    required: false
  helm-tag:
    description: 'Helm chart tag (if not provided, will be computed from git)'
    required: false

runs:
  using: "composite"
  steps:
    # ========== COMPUTE TAGS IF NOT PROVIDED ==========
    - name: Compute tags from git
      id: compute-tags-git
      if: inputs.tag == '' || inputs.helm-tag == ''
      uses: ./.github/actions/compute-tag

    - name: Set final tags
      id: compute-tags
      shell: bash
      run: |
        set -euo pipefail
        
        if [ -n "${{ inputs.tag }}" ]; then
          echo "Using provided tag: ${{ inputs.tag }}"
          TAG="${{ inputs.tag }}"
        else
          echo "Using computed tag: ${{ steps.compute-tags-git.outputs.tag }}"
          TAG="${{ steps.compute-tags-git.outputs.tag }}"
        fi
        echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
        
        # For artifact downloads, use git_tag (which is what build-backend-and-charts uses)
        if [ -n "${{ inputs.tag }}" ]; then
          # When tag is provided, assume it's the same as git_tag for artifact naming
          echo "git_tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
        else
          echo "git_tag=${{ steps.compute-tags-git.outputs.git_tag }}" >> "$GITHUB_OUTPUT"
        fi

    # ========== DOWNLOAD ARTIFACTS ==========
    - name: Download backend artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "*-${{ steps.compute-tags.outputs.git_tag }}"
        path: artifacts
        merge-multiple: true

    - name: Setup CLI binary
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p bin
        mv artifacts/flightctl-linux-amd64 bin/flightctl
        chmod +x bin/flightctl
        echo "CLI binary ready at bin/flightctl"

    # ========== INITIALIZE KIND CLUSTER ==========
    - name: Create kind cluster
      shell: bash
      run: make cluster

    # ========== LOAD IMAGES INTO KIND ==========
    - name: Load backend images into kind
      shell: bash
      run: |
        set -euo pipefail
        echo "Loading backend service images into kind"
        kind load image-archive artifacts/flightctl-images-bundle.tar
        echo "Backend images loaded successfully"

    - name: Clean up backend bundle files
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Cleaning up backend bundle files"
        echo "Removing backend bundle (no longer needed after loading into kind)..."
        rm artifacts/flightctl-images-bundle.tar
        df -h
        echo "::endgroup::"

    # ========== DEPLOY BACKEND ==========
    - name: Deploy FlightCtl backend with Helm
      shell: bash
      run: |
        set -euo pipefail
        CHART_FILE="artifacts/flightctl-chart.tgz"

        echo "Chart file: ${CHART_FILE}"
        echo "Image registry: quay.io/flightctl/"
        echo "Image tag: ${{ steps.compute-tags.outputs.tag }}"
        
        ./test/scripts/deploy_with_helm.sh \
          --chart-path="${CHART_FILE}" \
          --image-registry="quay.io/flightctl/" \
          --image-tag="${{ steps.compute-tags.outputs.tag }}"

