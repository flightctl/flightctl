name: 'Deploy Backend with Helm'
description: |
  Complete deployment of FlightCtl backend to a kind cluster using Helm.
  
  Downloads artifacts (images, chart, CLI), creates kind cluster, loads images,
  and deploys using helm.

inputs:
  tag:
    description: 'Image tag for artifacts (if not provided, will be computed from git)'
    required: false
  base-domain:
    description: 'Base domain for the deployment'
    required: true
  namespace-external:
    description: 'External namespace for FlightCtl API components'
    required: false
    default: 'flightctl-external'
  namespace-internal:
    description: 'Internal namespace for FlightCtl backend components'
    required: false
    default: 'flightctl-internal'
  additional-values-files:
    description: 'Space-separated list of additional Helm values files to apply (paths relative to repo root)'
    required: false
    default: ''
  auth-type:
    description: 'Authentication type (empty for default, "k8s" for Kubernetes auth)'
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    # ========== COMPUTE TAGS IF NOT PROVIDED ==========
    - name: Compute tags from git
      id: compute-tags-git
      if: inputs.tag == ''
      uses: ./.github/actions/compute-tag

    - name: Set git tag
      id: compute-tags
      shell: bash
      run: |
        set -euo pipefail
        
        if [ -n "${{ inputs.tag }}" ]; then
          echo "Using provided tag: ${{ inputs.tag }}"
          echo "git_tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
        else
          echo "Using computed git_tag: ${{ steps.compute-tags-git.outputs.git_tag }}"
          echo "git_tag=${{ steps.compute-tags-git.outputs.git_tag }}" >> "$GITHUB_OUTPUT"
        fi

    # ========== DOWNLOAD BACKEND ARTIFACTS ==========
    - name: Download backend images bundle
      uses: actions/download-artifact@v4
      with:
        name: flightctl-images-bundle-${{ steps.compute-tags.outputs.git_tag }}
        path: artifacts

    - name: Download helm chart
      uses: actions/download-artifact@v4
      with:
        name: helm-chart-${{ steps.compute-tags.outputs.git_tag }}
        path: artifacts

    - name: Download CLI binary
      uses: actions/download-artifact@v4
      with:
        name: flightctl-linux-amd64-${{ steps.compute-tags.outputs.git_tag }}
        path: artifacts

    - name: Setup CLI binary
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p bin
        mv artifacts/flightctl-linux-amd64 bin/flightctl
        chmod +x bin/flightctl
        echo "CLI binary ready at bin/flightctl"

    # ========== INITIALIZE KIND CLUSTER ==========
    - name: Create kind cluster
      shell: bash
      run: kind create cluster --config deploy/kind.yaml

    # ========== LOAD IMAGES INTO KIND ==========
    - name: Load backend images into kind
      shell: bash
      run: |
        set -euo pipefail
        echo "Loading backend service images into kind"
        kind load image-archive artifacts/flightctl-images-bundle.tar
        echo "Backend images loaded successfully"

    - name: Clean up backend bundle files
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Cleaning up backend bundle files"
        echo "Removing backend bundle (no longer needed after loading into kind)..."
        rm artifacts/flightctl-images-bundle.tar
        df -h
        echo "::endgroup::"

    # ========== DEPLOY BACKEND ==========
    - name: Deploy FlightCtl backend with Helm
      shell: bash
      env:
        BASE_DOMAIN: ${{ inputs.base-domain }}
        ADDITIONAL_VALUES_FILES: ${{ inputs.additional-values-files }}
        AUTH_TYPE: ${{ inputs.auth-type }}
      run: |
        set -euo pipefail

        kubectl create namespace ${{ inputs.namespace-internal }}
        ( kubectl get pods --all-namespaces -w | sed 's/^/[cluster] /' ) &

        # Build optional args
        EXTRA_ARGS=()
        for f in ${ADDITIONAL_VALUES_FILES}; do [ -f "$f" ] && EXTRA_ARGS+=(--values "$f"); done
        [ -n "${AUTH_TYPE}" ] && EXTRA_ARGS+=(--set "global.auth.type=${AUTH_TYPE}")

        helm install flightctl artifacts/flightctl-chart.tgz \
          --namespace ${{ inputs.namespace-external }} \
          --create-namespace \
          --values deploy/helm/flightctl/values.nodeport.yaml \
          --set global.baseDomain="${BASE_DOMAIN}" \
          --set global.internalNamespace=${{ inputs.namespace-internal }} \
          --set ui.enabled=false \
          "${EXTRA_ARGS[@]}" \
          --wait \
          --debug

    - name: "Wait for API readiness"
      uses: ./.github/actions/wait-for-api-readiness
      with:
        base-domain: ${{ inputs.base-domain }}

    - name: Generate deployment summary
      shell: bash
      env:
        IMAGE_TAG: ${{ steps.compute-tags.outputs.git_tag }}
        NAMESPACE_EXTERNAL: ${{ inputs.namespace-external }}
        NAMESPACE_INTERNAL: ${{ inputs.namespace-internal }}
        ADDITIONAL_VALUES_FILES: ${{ inputs.additional-values-files }}
        AUTH_TYPE: ${{ inputs.auth-type }}
        RUN_ID: ${{ github.run_id }}
      run: |
        set -euo pipefail
        
        # Build optional args for display
        EXTRA_ARGS=""
        for f in ${ADDITIONAL_VALUES_FILES}; do [ -f "$f" ] && EXTRA_ARGS+=" --values $f"; done
        [ -n "${AUTH_TYPE}" ] && EXTRA_ARGS+=" --set global.auth.type=${AUTH_TYPE}"
        
        {
          echo "### :rocket: Deployment"
          echo ""
          echo "Backend deployed successfully to kind cluster."
          echo ""
          echo "<details>"
          echo "<summary><strong>Reproduce Locally</strong></summary>"
          echo ""
          echo '```bash'
          echo "# Download artifacts"
          echo "mkdir -p bin artifacts"
          echo "gh run download ${RUN_ID} -n flightctl-images-bundle-${IMAGE_TAG} -D bin"
          echo "gh run download ${RUN_ID} -n helm-chart-${IMAGE_TAG} -D artifacts"
          echo ""
          echo "# Create kind cluster and load images"
          echo "kind create cluster --config deploy/kind.yaml"
          echo "kind load image-archive bin/flightctl-images-bundle.tar"
          echo ""
          echo "# Deploy"
          echo 'source ./test/scripts/functions && export BASE_DOMAIN=$(get_ext_ip).nip.io'
          echo "kubectl create namespace ${NAMESPACE_INTERNAL}"
          echo "helm install flightctl artifacts/flightctl-chart.tgz \\"
          echo "  --namespace ${NAMESPACE_EXTERNAL} \\"
          echo "  --create-namespace \\"
          echo "  --values deploy/helm/flightctl/values.nodeport.yaml \\"
          echo '  --set global.baseDomain="${BASE_DOMAIN}" \'
          echo "  --set global.internalNamespace=${NAMESPACE_INTERNAL} \\"
          echo "  --set ui.enabled=false${EXTRA_ARGS} \\"
          echo "  --wait"
          echo '```'
          echo ""
          echo "</details>"
        } >> "$GITHUB_STEP_SUMMARY"

