name: 'Check Admin Override Label'
description: |
  Checks if a specified override label exists on a pull request and validates
  that it was added by a repository admin or maintainer.

inputs:
  label-name:
    description: 'Name of the label to check for override'
    required: true

outputs:
  override:
    description: 'Whether the override is active (true/false)'
    value: ${{ steps.check_override.outputs.override }}

runs:
  using: "composite"
  steps:
    - name: Check if override label exists
      id: check_override
      uses: actions/github-script@v7
      with:
        script: |
          const labelName = '${{ inputs.label-name }}';
          
          // Get PR number - handle different event types
          let prNumber = null;
          if (context.payload.pull_request?.number) {
            prNumber = context.payload.pull_request.number;
          } else if (context.issue?.number) {
            prNumber = context.issue.number;
          } else if (context.eventName === 'merge_group') {
            // merge_group events don't have PR context
            console.log('merge_group event - no PR context available');
            core.setOutput('override', 'false');
            return;
          } else {
            console.log('No PR number found in context');
            core.setOutput('override', 'false');
            return;
          }

          // Fetch labels from API
          let labels = [];
          try {
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            labels = pr.labels.map(l => l.name);
            console.log(`PR #${prNumber} labels: ${labels.join(', ')}`);
          } catch (error) {
            console.log(`Error fetching PR: ${error.message}`);
            core.setOutput('override', 'false');
            return;
          }

          const labelExists = labels.includes(labelName);
          if (!labelExists) {
            console.log(`Label '${labelName}' not found on PR`);
            core.setOutput('override', 'false');
            return;
          }

          console.log(`Override label '${labelName}' found, verifying admin status...`);

          // Verify the label was added by an admin
          const { data: events } = await github.rest.issues.listEvents({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });
          
          let hasOverride = false;

          const labelEvents = events.filter(e =>
            e.event === 'labeled' &&
            e.label &&
            e.label.name === labelName
          );

          if (labelEvents.length > 0) {
            const lastLabelEvent = labelEvents[labelEvents.length - 1];
            console.log(`Label added by: ${lastLabelEvent.actor.login}`);

            // Check if user has admin permissions
            try {
              const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: lastLabelEvent.actor.login
              });

              const isAdmin = perm.permission === 'admin' || perm.permission === 'maintain';
              if (!isAdmin) {
                console.log(`User ${lastLabelEvent.actor.login} does not have admin/maintain permissions (has: ${perm.permission})`);
                hasOverride = false;
              } else {
                console.log(`Override approved by admin: ${lastLabelEvent.actor.login}`);
                hasOverride = true;
              }
            } catch (error) {
              console.log(`Error checking permissions: ${error.message}`);
              hasOverride = false;
            }
          } else {
            console.log('Could not find label event history');
            hasOverride = false;
          }

          core.setOutput('override', hasOverride.toString());
          console.log(`Final override status: ${hasOverride}`);