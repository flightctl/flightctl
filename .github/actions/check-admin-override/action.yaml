name: 'Check Admin Override Label'
description: |
  Checks if a specified override label exists on a pull request and validates
  that it was added by a repository admin or maintainer.

inputs:
  label-name:
    description: 'Name of the label to check for override'
    required: true

outputs:
  override:
    description: 'Whether the override is active (true/false)'
    value: ${{ steps.check_override.outputs.override }}

runs:
  using: "composite"
  steps:
    - name: Check if override label exists
      id: check_override
      uses: actions/github-script@v7
      with:
        script: |
          const labelName = '${{ inputs.label-name }}';
          const labels = context.payload.pull_request?.labels?.map(l => l.name) || [];
          let hasOverride = labels.includes(labelName);

          if (hasOverride) {
            console.log(`Override label '${labelName}' found, verifying admin status...`);

            // Verify the label was added by an admin
            const { data: events } = await github.rest.issues.listEvents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const labelEvents = events.filter(e =>
              e.event === 'labeled' &&
              e.label &&
              e.label.name === labelName
            );

            if (labelEvents.length > 0) {
              const lastLabelEvent = labelEvents[labelEvents.length - 1];

              // Check if user has admin permissions
              const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: lastLabelEvent.actor.login
              });

              const isAdmin = perm.permission === 'admin' || perm.permission === 'maintain';
              if (!isAdmin) {
                core.setFailed(`The ${labelName} label must be added by a repository admin`);
                hasOverride = false; // Disable override if not admin
              } else {
                console.log(`Override approved by admin: ${lastLabelEvent.actor.login}`);
              }
            } else {
              console.log('Could not find label event history');
              hasOverride = false;
            }
          }

          core.setOutput('override', hasOverride.toString());
          console.log(`Final override status: ${hasOverride}`);