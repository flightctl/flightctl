name: "Build Images and Charts"

on:
  workflow_call:
    inputs:
      tag:
        description: "Image tag"
        required: true
        type: string
      helm_tag:
        description: "Helm chart tag"
        required: true
        type: string
      git_tag:
        description: "Git tag for the build"
        required: true
        type: string
      git_tree_state:
        description: "Git tree state (clean/dirty)"
        required: true
        type: string
      git_commit:
        description: "Git commit SHA"
        required: true
        type: string
      expires_after:
        description: "TTL for images label quay.expires-after"
        required: false
        type: string
        default: ""

jobs:
  build-backend-containers:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Restore Go cache
        id: cache-go-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build backend containers
        env:
          SOURCE_GIT_TAG: ${{ inputs.git_tag }}
          SOURCE_GIT_TREE_STATE: ${{ inputs.git_tree_state }}
          SOURCE_GIT_COMMIT: ${{ inputs.git_commit }}
          GITHUB_ACTIONS: true
          REGISTRY: quay.io
          REGISTRY_OWNER: flightctl
        run: |
          set -euo pipefail
          
          echo "::group::Building backend containers"
          make build-containers
          echo "::endgroup::"

      - name: Bundle images
        env:
          TAG: ${{ inputs.git_tag }}
        run: |
          set -euo pipefail
          
          echo "::group::Creating images bundle"
          echo "Getting list of loaded flightctl images with tag: $TAG"
          mapfile -t loaded_images < <(podman images --format "{{.Repository}}:{{.Tag}}" | grep "quay\.io/flightctl/flightctl-.*:${TAG}")

          echo "Creating bundle with ${#loaded_images[@]} images:"
          printf '  %s\n' "${loaded_images[@]}"

          podman save --format docker-archive -o flightctl-images-bundle.tar -m "${loaded_images[@]}"

          echo "Bundle created: $(ls -lh flightctl-images-bundle.tar)"
          echo "::endgroup::"

      - name: Upload images bundle
        uses: actions/upload-artifact@v4
        with:
          name: flightctl-images-bundle
          path: flightctl-images-bundle.tar
          compression-level: 1
          if-no-files-found: error
          retention-days: 1

      - name: Save Go cache
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

  build-auxiliary-images:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        image: ['git-server']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Build image
        id: build
        uses: redhat-actions/buildah-build@v2
        with:
          image: quay.io/flightctl-tests/${{ matrix.image }}
          tags: ${{ inputs.tag }}
          labels: |
            org.flightctl.${{ matrix.image }}.github.repository=${{ github.repository }}
            org.flightctl.${{ matrix.image }}.github.actor=${{ github.actor }}
            org.flightctl.${{ matrix.image }}.github.run_id=${{ github.run_id }}
            org.flightctl.${{ matrix.image }}.github.sha=${{ github.sha }}
            org.flightctl.${{ matrix.image }}.github.ref_name=${{ github.ref_name }}
          containerfiles: test/scripts/auxiliary-images-v2/Containerfile.${{ matrix.image }}
          context: .

      - name: Save image archive
        id: save
        env:
          TAG: ${{ inputs.tag }}
          IMAGE: ${{ steps.build.outputs.image }}
          MATRIX_IMAGE: ${{ matrix.image }}
        run: |
          set -euo pipefail
          
          ARCHIVE_NAME="auxiliary-image-${MATRIX_IMAGE}.tar"
          
          echo "Saving ${IMAGE}:${TAG} to ${ARCHIVE_NAME}"
          podman save -o "${ARCHIVE_NAME}" "${IMAGE}:${TAG}"
          
          echo "archive=${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: auxiliary-image-${{ matrix.image }}
          path: ${{ steps.save.outputs.archive }}
          compression-level: 1
          if-no-files-found: error
          retention-days: 1

  service-images-manifest:
    runs-on: ubuntu-24.04
    needs: [build-backend-containers]
    steps:
      - name: Download images bundle
        uses: actions/download-artifact@v4
        with:
          name: flightctl-images-bundle
          path: .

      - name: Load images and extract digests
        env:
          TAG: ${{ inputs.git_tag }}
        run: |
          set -euo pipefail
          
          echo "::group::Loading images bundle"
          podman load -i flightctl-images-bundle.tar
          echo "::endgroup::"
          
          echo "::group::Extracting image digests"
          mkdir -p digests
          images=(
            flightctl-api
            flightctl-db-setup
            flightctl-worker
            flightctl-periodic
            flightctl-alert-exporter
            flightctl-alertmanager-proxy
            flightctl-cli-artifacts
            flightctl-userinfo-proxy
            flightctl-telemetry-gateway
          )
          
          for img in "${images[@]}"; do
            image_name="quay.io/flightctl/${img}:${TAG}"
            digest=$(podman inspect "${image_name}" --format '{{.Digest}}' || true)
            if [ -n "$digest" ]; then
              echo "$digest" > "digests/${img#flightctl-}.txt"
              echo "Extracted digest for ${img}: ${digest}"
            else
              echo "Warning: Could not extract digest for ${img}" >&2
            fi
          done
          echo "::endgroup::"

      - name: Produce service images manifest
        run: |
          set -euo pipefail
          TAG='${{ inputs.git_tag }}'
          ARTIFACT_BASE_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}#artifacts"
          images=(
            flightctl-api
            flightctl-db-setup
            flightctl-worker
            flightctl-periodic
            flightctl-alert-exporter
            flightctl-alertmanager-proxy
            flightctl-cli-artifacts
            flightctl-userinfo-proxy
            flightctl-telemetry-gateway
          )
          printf '{"serviceImages":{' > service-images.json
          first=1
          for img in "${images[@]}"; do
            archive_name="flightctl-images-bundle.tar"
            artifact_name="flightctl-images-bundle"
            digest_file="digests/${img#flightctl-}.txt"
            if [ ! -f "$digest_file" ]; then
              echo "Missing digest file: $digest_file" >&2
              exit 1
            fi
            digest=$(cat "$digest_file")
            if [ $first -eq 0 ]; then printf ',' >> service-images.json; fi
            first=0
            printf '"%s":{"archiveName":"%s","artifactName":"%s","artifactUrl":"%s","digest":"%s"}' "$img" "$archive_name" "$artifact_name" "$ARTIFACT_BASE_URL" "$digest" >> service-images.json
          done
          printf '}}' >> service-images.json
          cat service-images.json

      - name: Upload service images manifest
        uses: actions/upload-artifact@v4
        with:
          name: service-images-manifest
          path: service-images.json
          compression-level: 0
          if-no-files-found: error
          retention-days: 1

  build-helm-charts:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Build helm charts
        id: build-charts
        run: |
          set -euo pipefail
          TAG="${{ inputs.helm_tag }}"
          
          echo "::group::Building helm charts"
          helm dependency build ./deploy/helm/flightctl
          helm package ./deploy/helm/flightctl \
            --version "$TAG" \
            --app-version "$TAG"
          echo "::endgroup::"
          
          echo "::group::Computing chart digest"
          CHART_FILE="flightctl-${TAG}.tgz"
          DIGEST=$(sha256sum "$CHART_FILE" | awk '{print $1}')
          echo "sha256:${DIGEST}" > charts-digest.txt
          echo "Chart file: $CHART_FILE"
          echo "Digest: sha256:${DIGEST}"
          echo "::endgroup::"
          
          echo "chart_file=$CHART_FILE" >> "$GITHUB_OUTPUT"
          echo "digest=sha256:${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Upload helm chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: ${{ steps.build-charts.outputs.chart_file }}
          compression-level: 0
          if-no-files-found: error
          retention-days: 1

      - name: Produce charts manifest
        run: |
          set -euo pipefail
          name="flightctl"
          version="${{ inputs.helm_tag }}"
          artifact_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}#artifacts"
          digest="${{ steps.build-charts.outputs.digest }}"
          chart_file="${{ steps.build-charts.outputs.chart_file }}"
          jq -n \
            --arg n "$name" \
            --arg v "$version" \
            --arg u "$artifact_url" \
            --arg d "$digest" \
            --arg f "$chart_file" \
            '{charts:{($n):{version:$v,artifactUrl:$u,digest:$d,chartFile:$f}}}' > charts.json
          cat charts.json

      - name: Upload charts manifest
        uses: actions/upload-artifact@v4
        with:
          name: charts-manifest
          path: charts.json
          compression-level: 0
          if-no-files-found: error
          retention-days: 1

