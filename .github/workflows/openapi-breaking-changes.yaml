name: "OpenAPI Breaking Changes Check"

on:
  pull_request:
    paths:
      - 'api/**/openapi.yaml'

jobs:
  oasdiff-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect base for comparison
        id: detect_base
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "Detecting base commit for API comparison..."
          echo ""

          API_GLOB=':(glob)api/v1alpha1/**/openapi.yaml'

          # Ensure tags exist locally (required for rev-list against the release tag)
          git fetch --tags --force >/dev/null 2>&1 || true

          # A) Latest release API change
          LATEST_RELEASE_TAG="$(gh release view --json tagName --jq .tagName)"
          LATEST_RELEASE_COMMIT="$(git rev-list -1 "${LATEST_RELEASE_TAG}" -- "${API_GLOB}" || true)"
          if [ -n "${LATEST_RELEASE_COMMIT}" ]; then
            LATEST_RELEASE_DATE="$(git show -s --format=%ct "${LATEST_RELEASE_COMMIT}")"
            echo "Latest release: ${LATEST_RELEASE_TAG}"
            echo "Latest API change in release: ${LATEST_RELEASE_COMMIT} on $(date -ud "@${LATEST_RELEASE_DATE}" +%Y-%m-%dT%H:%M:%SZ)"
          else
            LATEST_RELEASE_DATE="0"
            echo "Latest release: ${LATEST_RELEASE_TAG} (no API changes found)"
          fi
          echo ""
          
          # B) Latest merged PR with the approval label (sorted by merged time desc)
          PR_JSON="$(gh pr list \
            --state merged \
            --search "label:'breaking-change-approved' sort:merged-desc" \
            --limit 1 \
            --json number,mergeCommit,mergedAt)"

          LATEST_BREAKING_PR="$(jq -r '.[0].number' <<<"${PR_JSON}")"
          LATEST_BREAKING_COMMIT="$(jq -r '.[0].mergeCommit.oid' <<<"${PR_JSON}")"
          LATEST_BREAKING_DATE="$(jq -r '.[0].mergedAt' <<<"${PR_JSON}" | xargs -I{} date -ud {} +%s)"
          echo "Latest breaking-change-approved PR: #${LATEST_BREAKING_PR} (${LATEST_BREAKING_COMMIT}) on $(date -ud "@${LATEST_BREAKING_DATE}" +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          
          # Choose the most recent of the two
          echo "================================================"
          echo ""
          if [ -n "${LATEST_RELEASE_COMMIT}" ] && [ "${LATEST_RELEASE_DATE}" -gt "${LATEST_BREAKING_DATE}" ]; then
            BASE_COMMIT="${LATEST_RELEASE_COMMIT}"
            echo "Using release API change commit as base (more recent)."
          else
            BASE_COMMIT="${LATEST_BREAKING_COMMIT}"
            echo "Using breaking-change-approved PR commit as base (more recent)."
          fi
          echo "Selected base commit: ${BASE_COMMIT}"
          echo "Commit link: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${BASE_COMMIT}"
          echo "================================================"
          echo ""
          echo "base_commit=${BASE_COMMIT}" >> "$GITHUB_OUTPUT"
      - name: Checkout base commit for comparison
        run: |
          echo "Preparing base API files from: ${{ steps.detect_base.outputs.base_commit }}"
          git fetch origin ${{ github.event.pull_request.base.ref }}
          mkdir -p base-api/v1alpha1/agent
          git show ${{ steps.detect_base.outputs.base_commit }}:api/v1alpha1/openapi.yaml > base-api/v1alpha1/openapi.yaml || true
          git show ${{ steps.detect_base.outputs.base_commit }}:api/v1alpha1/agent/openapi.yaml > base-api/v1alpha1/agent/openapi.yaml || true

      - name: Check if override label exists
        id: check_override
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            let hasOverride = labels.includes('breaking-change-approved');
            
            if (hasOverride) {
              console.log('Breaking change override label found, verifying admin status...');
              
              // Verify the label was added by an admin
              const { data: events } = await github.rest.issues.listEvents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              const labelEvents = events.filter(e => 
                e.event === 'labeled' && 
                e.label && 
                e.label.name === 'breaking-change-approved'
              );
              
              if (labelEvents.length > 0) {
                const lastLabelEvent = labelEvents[labelEvents.length - 1];
                
                // Check if user has admin permissions
                const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  username: lastLabelEvent.actor.login
                });
                
                const isAdmin = perm.permission === 'admin' || perm.permission === 'maintain';
                if (!isAdmin) {
                  core.setFailed('The breaking-change-approved label must be added by a repository admin');
                  hasOverride = false; // Disable override if not admin
                } else {
                  console.log(`Override approved by admin: ${lastLabelEvent.actor.login}`);
                }
              } else {
                console.log('Could not find label event history');
                hasOverride = false;
              }
            }
            
            core.setOutput('override', hasOverride.toString());
            console.log(`Final override status: ${hasOverride}`);

      - name: Breaking Changes Check
        if: ${{ steps.check_override.outputs.override != 'true' }}
        run: |
          echo "Checking for breaking API changes..."
          echo "================================================"
          echo ""

      - name: Check breaking changes in main API
        id: breaking_main
        if: ${{ steps.check_override.outputs.override != 'true' }}
        uses: oasdiff/oasdiff-action/breaking@main
        with:
          base: base-api/v1alpha1/openapi.yaml
          revision: api/v1alpha1/openapi.yaml
          fail-on: ERR
        continue-on-error: true

      - name: Check breaking changes in agent API
        id: breaking_agent
        if: ${{ steps.check_override.outputs.override != 'true' }}
        uses: oasdiff/oasdiff-action/breaking@main
        with:
          base: base-api/v1alpha1/agent/openapi.yaml
          revision: api/v1alpha1/agent/openapi.yaml
          fail-on: ERR
        continue-on-error: true

      - name: Breaking Changes Summary
        if: ${{ steps.check_override.outputs.override != 'true' && (steps.breaking_main.outcome == 'failure' || steps.breaking_agent.outcome == 'failure') }}
        run: |
          echo ""
          echo "================================================"
          echo "BREAKING CHANGES DETECTED"
          echo "================================================"
          echo ""
          echo "This PR contains breaking changes to the API specification."
          echo "See the detailed report above for specific changes."
          echo ""
          echo "To proceed with these changes:"
          echo "- Have an admin add the 'breaking-change-approved' label to this PR"
          echo ""
          exit 1

      - name: Log breaking changes override
        if: ${{ steps.check_override.outputs.override == 'true' }}
        run: |
          echo "================================================"
          echo "BREAKING CHANGES CHECK BYPASSED"
          echo "================================================"
          echo "The breaking-change-approved label has been applied by an admin."
          echo "Skipping breaking changes validation."
