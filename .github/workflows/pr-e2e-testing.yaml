name: "E2E testing (Parallel Build)"

on:
  workflow_dispatch:
    inputs:
      label_filter:
        description: 'Ginkgo label filter expression to filter e2e tests'
        required: false
        default: 'sanity'
        type: string
  push:
    branches:
      - main
      - 'release-*'
  pull_request:
  merge_group:

permissions:
  contents: read
  pull-requests: read

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  QUAY_ORG: quay.io/flightctl
  QUAY_TESTS_ORG: quay.io/flightctl-tests
  REGISTRY: quay.io
  REGISTRY_OWNER: flightctl
  REGISTRY_OWNER_TESTS: flightctl-tests
  GITHUB_ACTIONS: true

jobs:
  compute-tag:
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ steps.compute-tag.outputs.git_tag }}
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          since_last_remote_commit: 'true'
          files_ignore: |
            .spelling
            README.md
            docs/**
            .github/**
            examples/**

      - name: Compute tag
        id: compute-tag
        if: ${{ steps.changed-files.outputs.any_changed == 'true' }}
        uses: ./.github/actions/compute-tag

  build-images-and-charts:
    needs: compute-tag
    if: needs.compute-tag.outputs.any_changed == 'true'
    uses: ./.github/workflows/build-images-and-charts.yaml

  build-flightctl-cli:
    needs: build-images-and-charts
    if: needs.compute-tag.outputs.any_changed == 'true'
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ needs.build-images-and-charts.outputs.git_tag }}
    steps:
      - name: CLI built with backend job
        run: echo "CLI artifact produced by build-images-and-charts"

  build-rpms:
    needs: compute-tag
    if: needs.compute-tag.outputs.any_changed == 'true'
    strategy:
      matrix:
        include:
          - root: centos-stream+epel-next-9-x86_64
          - root: epel-10-x86_64
    uses: ./.github/workflows/build-rpms.yaml
    with:
      root: ${{ matrix.root }}

  build-agent-images-unified:
    needs: [compute-tag, build-rpms]
    if: needs.compute-tag.outputs.any_changed == 'true'
    strategy:
      matrix:
        include:
          - os_id: cs9-bootc
            rpm_suffix: centos-stream+epel-next-9-x86_64
          - os_id: cs10-bootc
            rpm_suffix: epel-10-x86_64
    uses: ./.github/workflows/build-agent-images.yaml
    with:
      rpm_suffix: ${{ matrix.rpm_suffix }}
      os_id: ${{ matrix.os_id }}
      tag: ${{ needs.compute-tag.outputs.tag }}

  e2e-tests:
    needs:
      - compute-tag
      - build-images-and-charts
      - build-flightctl-cli
      - build-agent-images-unified
    if: needs.compute-tag.outputs.any_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_id: cs9-bootc
            backend_type: helm
    uses: ./.github/workflows/run-e2e-tests.yaml
    with:
      os_id: ${{ matrix.os_id }}
      backend_type: ${{ matrix.backend_type }}
      ginkgo_total_nodes: 4
      ginkgo_label_filter: ${{ inputs.label_filter || 'sanity' }}
      tag: ${{ needs.compute-tag.outputs.tag }}

  e2e:
    runs-on: ubuntu-latest
    needs: [compute-tag, e2e-tests]
    if: always()
    steps:
      - name: Check E2E Test Results
        run: |
          if [[ "${{ needs.compute-tag.outputs.any_changed }}" != "true" ]]; then
            echo "E2E tests were skipped (docs-only or ignored paths)"
            exit 0
          fi
          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "All E2E tests passed!"
            exit 0
          elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
            echo "E2E tests were skipped (docs-only changes)"
            exit 0
          else
            echo "E2E tests failed or were cancelled"
            exit 1

