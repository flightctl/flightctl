name: "E2E testing (Parallel Build)"

on:
  workflow_dispatch:
    inputs:
      label_filter:
        description: 'Ginkgo label filter expression to filter e2e tests'
        required: false
        default: 'sanity'
        type: string
  push:
    branches:
      - main
      - 'release-*'
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  merge_group:

permissions:
  contents: read
  pull-requests: read

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  QUAY_ORG: quay.io/flightctl
  QUAY_TESTS_ORG: quay.io/flightctl-tests
  REGISTRY: quay.io
  REGISTRY_OWNER: flightctl
  REGISTRY_OWNER_TESTS: flightctl-tests
  GITHUB_ACTIONS: true

jobs:
  compute-tag:
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ steps.compute-tag.outputs.git_tag }}
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          since_last_remote_commit: 'true'
          files_ignore: |
            .spelling
            README.md
            docs/**
            examples/**

      - name: Compute tag
        id: compute-tag
        if: ${{ steps.changed-files.outputs.any_changed == 'true' }}
        uses: ./.github/actions/compute-tag

  build-images-and-charts:
    needs: compute-tag
    if: |
      needs.compute-tag.outputs.any_changed == 'true' &&
      (github.event_name != 'pull_request' || startsWith(github.base_ref, 'release-') || contains(github.event.pull_request.labels.*.name, 'run-e2e'))
    uses: ./.github/workflows/build-images-and-charts.yaml

  build-flightctl-cli:
    needs: [build-images-and-charts, compute-tag]
    if: |
      needs.compute-tag.outputs.any_changed == 'true' &&
      (github.event_name != 'pull_request' || startsWith(github.base_ref, 'release-') || contains(github.event.pull_request.labels.*.name, 'run-e2e'))
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ needs.compute-tag.outputs.tag }}
    steps:
      - name: CLI built with backend job
        run: echo "CLI artifact produced by build-images-and-charts"

  build-rpms:
    needs: compute-tag
    if: |
      needs.compute-tag.outputs.any_changed == 'true' &&
      (github.event_name != 'pull_request' || startsWith(github.base_ref, 'release-') || contains(github.event.pull_request.labels.*.name, 'run-e2e'))
    strategy:
      matrix:
        include:
          - root: centos-stream+epel-next-9-x86_64
          - root: epel-10-x86_64
    uses: ./.github/workflows/build-rpms.yaml
    with:
      root: ${{ matrix.root }}

  build-agent-images-unified:
    needs: [compute-tag, build-rpms]
    if: |
      needs.compute-tag.outputs.any_changed == 'true' &&
      (github.event_name != 'pull_request' || startsWith(github.base_ref, 'release-') || contains(github.event.pull_request.labels.*.name, 'run-e2e'))
    strategy:
      matrix:
        include:
          - os_id: cs9-bootc
            rpm_suffix: centos-stream+epel-next-9-x86_64
          - os_id: cs10-bootc
            rpm_suffix: epel-10-x86_64
    uses: ./.github/workflows/build-agent-images.yaml
    with:
      rpm_suffix: ${{ matrix.rpm_suffix }}
      os_id: ${{ matrix.os_id }}
      tag: ${{ needs.compute-tag.outputs.tag }}

  discover-e2e-tests:
    needs: compute-tag
    if: |
      needs.compute-tag.outputs.any_changed == 'true' &&
      (github.event_name != 'pull_request' || startsWith(github.base_ref, 'release-') || contains(github.event.pull_request.labels.*.name, 'run-e2e'))
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - label_filter: 'sanity && !agent'
          - label_filter: 'sanity && agent && !slow'
          - label_filter: 'sanity && agent && slow'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dependencies
        uses: ./.github/actions/setup-dependencies

      - name: Compute label filter hash
        id: compute-hash
        run: |
          HASH=$(printf '%s' "${{ matrix.label_filter }}" | sha256sum | cut -c1-8)
          echo "hash=${HASH}" >> "$GITHUB_OUTPUT"
          echo "Label filter: ${{ matrix.label_filter }}"
          echo "Hash: ${HASH}"

      - name: Run test discovery
        env:
          GINKGO_LABEL_FILTER: ${{ matrix.label_filter }}
          DISCOVERY_ONLY: "true"
          DISCOVERY_PATH: discovery.json
        run: |
          mkdir -p reports
          test/scripts/run_e2e_tests.sh reports ./test/e2e/...

      - name: Validate discovery results
        run: |
          echo "=== Discovery file info ==="
          ls -la discovery.json

          echo ""
          echo "=== Discovery content (formatted) ==="
          jq '.' discovery.json

          echo ""
          echo "=== Tests found ==="
          TEST_COUNT=$(jq -r '[.[] | .SpecReports[]? | select(.LeafNodeLabels != null)] | length' discovery.json)
          echo "Total tests found with filter '${{ matrix.label_filter }}': ${TEST_COUNT}"

          if [[ "${TEST_COUNT}" -eq 0 ]]; then
            echo "ERROR: No tests found in discovery! Check for compilation errors above."
            exit 1
          fi

      - name: Upload discovery artifact
        uses: actions/upload-artifact@v4
        with:
          name: e2e-discovery-${{ steps.compute-hash.outputs.hash }}-${{ needs.compute-tag.outputs.tag }}
          path: discovery.json
          retention-days: 1

  e2e-tests:
    needs:
      - compute-tag
      - build-images-and-charts
      - build-flightctl-cli
      - build-agent-images-unified
      - discover-e2e-tests
    if: |
      needs.compute-tag.outputs.any_changed == 'true' &&
      (github.event_name != 'pull_request' || startsWith(github.base_ref, 'release-') || contains(github.event.pull_request.labels.*.name, 'run-e2e'))
    strategy:
      fail-fast: false
      matrix:
        include:
          # Non-Agent metrics
          ## CS9
          - os_id: cs9-bootc
            backend_type: helm
            label_filter: 'sanity && !agent'
            ginkgo_total_nodes: 1
          # Agent metrics
          ## CS9 Agent metrics
          - os_id: cs9-bootc
            backend_type: helm
            label_filter: 'sanity && agent && !slow'
            ginkgo_total_nodes: 2
          - os_id: cs9-bootc
            backend_type: helm
            label_filter: 'sanity && agent && slow'
            ginkgo_total_nodes: 1
          ## CS10 Agent metrics
          - os_id: cs10-bootc
            backend_type: helm
            label_filter: 'sanity && agent && !slow'
            ginkgo_total_nodes: 2
          - os_id: cs10-bootc
            backend_type: helm
            label_filter: 'sanity && agent && slow'
            ginkgo_total_nodes: 1
    uses: ./.github/workflows/run-e2e-tests.yaml
    with:
      os_id: ${{ matrix.os_id }}
      backend_type: ${{ matrix.backend_type }}
      ginkgo_total_nodes: ${{ matrix.ginkgo_total_nodes }}
      ginkgo_label_filter: ${{ matrix.label_filter }}
      tag: ${{ needs.compute-tag.outputs.tag }}

  e2e:
    runs-on: ubuntu-latest
    needs: [ compute-tag, e2e-tests ]
    if: always()
    steps:
      - name: Check E2E Test Results
        env:
          HAS_RUN_E2E_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'run-e2e') }}
        run: |
          if [[ "${{ needs.compute-tag.outputs.any_changed }}" != "true" ]]; then
            echo "E2E tests were skipped (docs-only or ignored paths)"
            exit 0
          fi
          # PRs targeting main skip e2e unless 'run-e2e' label is present
          if [[ "${{ github.event_name }}" == "pull_request" && ! "${{ github.base_ref }}" =~ ^release- && "${HAS_RUN_E2E_LABEL}" != "true" ]]; then
            echo "E2E tests skipped for PRs targeting main (will run in merge queue)"
            echo "To run e2e tests on this PR, add the 'run-e2e' label"
            exit 0
          fi
          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "All E2E tests passed!"
            exit 0
          elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
            echo "E2E tests were skipped"
            exit 0
          else
            echo "E2E tests failed or were cancelled"
            exit 1
          fi
