name: "Run E2E Tests"

on:
  workflow_call:
    inputs:
      os_id:
        description: "OS identifier for agent (e.g., cs9, cs10)"
        required: true
        type: string
      backend_type:
        description: "Backend deployment type (helm)"
        required: false
        type: string
        default: 'helm'
      ginkgo_total_nodes:
        description: "Total number of Ginkgo nodes"
        required: false
        type: number
        default: 8
      ginkgo_label_filter:
        description: "Ginkgo label filter"
        required: false
        type: string
        default: 'sanity'
      tag:
        description: "Image tag"
        required: true
        type: string
      helm_tag:
        description: "Helm chart tag"
        required: true
        type: string

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      nodes: ${{ steps.generate.outputs.nodes }}
    steps:
      - name: Generate node matrix
        id: generate
        run: |
          nodes=$(seq 1 ${{ inputs.ginkgo_total_nodes }} | jq -R . | jq -s -c .)
          echo "nodes=${nodes}" >> "$GITHUB_OUTPUT"
          echo "Generated nodes matrix: ${nodes}"

  e2e-test:
    runs-on: ubuntu-24.04
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        ginkgo_node: ${{ fromJson(needs.generate-matrix.outputs.nodes) }}
    steps:
      # ========== PREPARE ENVIRONMENT ==========
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android >/dev/null 2>&1 &
          echo "Started background removal of /usr/local/lib/android (PID: $!)"
          df -h

      - name: Start disk space monitoring
        run: |
          cat > /tmp/disk_monitor.sh << 'EOF'
          #!/bin/bash
          prev_percent=0

          # Cleanup function
          cleanup() {
            echo "Disk monitoring stopped"
            exit 0
          }

          # Handle termination signals
          trap cleanup TERM INT EXIT

          while [ ! -f /tmp/stop_disk_monitor ]; do
            usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            echo "$usage" > /tmp/disk_usage_percent.txt

            if [ "$usage" -gt 90 ] && [ "$usage" -gt "$prev_percent" ]; then
              echo "::warning::Disk usage is at ${usage}% and growing"
              prev_percent=$usage
            fi

            sleep 1
          done

          cleanup
          EOF
          chmod +x /tmp/disk_monitor.sh
          /tmp/disk_monitor.sh &
          MONITOR_PID=$!
          echo "MONITOR_PID=$MONITOR_PID" >> $GITHUB_ENV
          echo "Disk monitoring started in background (PID: $MONITOR_PID)"

      # ========== SETUP DEPENDENCIES ==========
      - name: Setup dependencies (KVM, libvirt, etc)
        uses: ./.github/actions/setup-dependencies
        with:
          setup_kvm: yes

      # ========== DEPLOY BACKEND WITH HELM ==========
      - name: Deploy backend with Helm
        if: inputs.backend_type == 'helm'
        uses: ./.github/actions/deploy-backend-with-helm
        with:
          tag: ${{ inputs.tag }}
          helm-tag: ${{ inputs.helm_tag }}

      # ========== SETUP E2E ENVIRONMENT ==========
      - name: Download E2E artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "{auxiliary-image-git-server,agent-images-bundle-${{ inputs.os_id }},sleep-app-images-bundle,agent-qcow2-image-${{ inputs.os_id }}}"
          path: artifacts
          merge-multiple: true

      - name: Normalize agent images bundle name
        run: |
          set -euo pipefail
          src="artifacts/agent-images-bundle-${{ inputs.os_id }}.tar"
          if [ -f "${src}" ]; then
            mv -f "${src}" artifacts/agent-images-bundle.tar
          fi

      - name: Normalize qcow2 path
        run: |
          set -euo pipefail
          mkdir -p bin/output/qcow2
          src=""
          if [ -f artifacts/output/qcow2/disk.qcow2 ]; then
            src="artifacts/output/qcow2/disk.qcow2"
          elif [ -f artifacts/disk.qcow2 ]; then
            src="artifacts/disk.qcow2"
          else
            src=$(find artifacts -maxdepth 3 -type f -name 'disk.qcow2' | head -n1 || true)
          fi
          if [ -z "${src}" ]; then
            echo "disk.qcow2 not found in artifacts" >&2
            exit 1
          fi
          mv -f "${src}" bin/output/qcow2/disk.qcow2

      - name: Load git-server image into kind
        run: |
          set -euo pipefail
          echo "Loading git-server image into kind"
          kind load image-archive artifacts/auxiliary-image-git-server.tar
          echo "Git-server image loaded successfully"

      - name: Clean up auxiliary bundle
        run: |
          set -euo pipefail
          echo "Removing git-server bundle..."
          rm -f artifacts/auxiliary-image-git-server.tar
          df -h

      - name: Create E2E certificates and SSH keys
        run: |
          set -euo pipefail
          ./test/scripts/create_e2e_certs.sh

      - name: Deploy E2E extras (registry, git-server)
        run: |
          set -euo pipefail
          export GITSERVER_IMAGE="quay.io/flightctl-tests/git-server:${{ inputs.tag }}"
          ./test/scripts/deploy_e2e_extras_with_helm.sh

      - name: Push agent and sleep app images to E2E registry
        run: |
          set -euo pipefail
          echo "::group::Pushing agent and sleep app images to E2E registry"
          
          # Verify required files exist
          if [ ! -f artifacts/agent-images-bundle.tar ]; then
            echo "::error::artifacts/agent-images-bundle.tar not found"
            exit 1
          fi
          if [ ! -f artifacts/sleep-app-images-bundle.tar ]; then
            echo "::error::artifacts/sleep-app-images-bundle.tar not found"
            exit 1
          fi
          
          source ./test/scripts/functions
          export REGISTRY_ENDPOINT="$(registry_address)"
          echo "Using REGISTRY_ENDPOINT=${REGISTRY_ENDPOINT}"
          
          echo "Pushing agent images bundle..."
          ./test/scripts/agent-images-v2/upload-images.sh artifacts/agent-images-bundle.tar --insecure --jobs 2
          agent_exit=$?
          if [ $agent_exit -ne 0 ]; then
            echo "::error::Failed to push agent images (exit code: $agent_exit)"
            exit $agent_exit
          fi
          
          echo "Pushing sleep app images bundle..."
          ./test/scripts/agent-images-v2/upload-images.sh artifacts/sleep-app-images-bundle.tar --insecure --jobs 2
          sleep_exit=$?
          if [ $sleep_exit -ne 0 ]; then
            echo "::error::Failed to push sleep app images (exit code: $sleep_exit)"
            exit $sleep_exit
          fi
          
          echo "Successfully pushed all images to registry"
          echo "::endgroup::"

      - name: Clean up agent and sleep app bundles
        run: |
          set -euo pipefail
          echo "::group::Cleaning up agent and sleep app bundle files"
          echo "Removing agent and sleep app bundles (no longer needed after push to E2E registry)..."
          rm -f artifacts/agent-images-bundle.tar
          rm -f artifacts/sleep-app-images-bundle.tar
          echo "All bundle files cleaned up"
          df -h
          echo "::endgroup::"

      - name: Prune Podman images (post-push)
        run: |
          set -euo pipefail
          echo "::group::Pruning Podman images to free space"
          podman image prune -af
          podman system df || true
          df -h
          echo "::endgroup::"

      - name: Prepare agent configuration
        run: |
          set -euo pipefail
          ./test/scripts/agent-images-v2/prepare_agent_config.sh --status-update-interval 0m2s --spec-fetch-interval 0m2s

      - name: Inject agent files into qcow2
        run: |
          set -euo pipefail
          echo "::group::Injecting agent config and certs into qcow2"
          source ./test/scripts/functions
          ADDR="$(registry_address)"
          bash ./test/scripts/inject_agent_files_into_qcow.sh \
            --qcow bin/output/qcow2/disk.qcow2 \
            --agent-dir bin/agent/etc/flightctl \
            --mount-dir /mnt/qcow \
            --registry-addr "$ADDR" \
            --e2e-ca bin/e2e-certs/pki/CA/ca.crt
          echo "::endgroup::"

      - name: Setup E2E test environment
        run: |
          set -euo pipefail
          ./test/scripts/setup_e2e_environment.sh
          df -h

      # ========== RUN E2E TESTS ==========
      - name: Run E2E tests
        run: |
          set -euo pipefail
          source ./test/scripts/functions
          export REGISTRY_ENDPOINT=$(registry_address)
          make run-e2e-test VERBOSE=true
        env:
          GINKGO_LABEL_FILTER: ${{ inputs.ginkgo_label_filter }}
          GINKGO_TOTAL_NODES: ${{ inputs.ginkgo_total_nodes }}
          GINKGO_NODE: ${{ matrix.ginkgo_node }}

      - name: Collect and Upload Logs
        if: always()
        uses: ./.github/actions/collect-logs
        with:
          namespace-external: 'flightctl-external'
          namespace-internal: 'flightctl-internal'
          log-directory: 'e2e-logs-${{ inputs.os_id }}-node-${{ matrix.ginkgo_node }}'

      - name: Stop disk space monitoring
        if: always()
        run: |
          echo "Stopping disk monitoring..."
          touch /tmp/stop_disk_monitor
          if [ -n "${MONITOR_PID:-}" ]; then
            kill $MONITOR_PID 2>/dev/null || true
          fi
          echo "Disk monitoring stopped"
          df -h

