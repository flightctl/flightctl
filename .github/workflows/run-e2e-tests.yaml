name: "Run E2E Tests"

on:
  workflow_call:
    inputs:
      os_id:
        description: "OS identifier for agent (e.g., el9-bootc, el10-bootc)"
        required: true
        type: string
      backend_type:
        description: "Backend deployment type (helm)"
        required: false
        type: string
        default: "helm"
      ginkgo_total_nodes:
        description: "Total number of Ginkgo nodes"
        required: false
        type: number
        default: 4
      ginkgo_label_filter:
        description: "Ginkgo label filter"
        required: false
        type: string
        default: "sanity"
      tag:
        description: "Image tag"
        required: true
        type: string
      flavor:
        description: "Container flavor (el9 or el10)"
        required: false
        type: string
        default: "el9"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      nodes: ${{ steps.generate.outputs.nodes }}
    steps:
      - name: Generate node matrix
        id: generate
        run: |
          nodes=$(seq 1 ${{ inputs.ginkgo_total_nodes }} | jq -R . | jq -s -c .)
          echo "nodes=${nodes}" >> "$GITHUB_OUTPUT"
          echo "Generated nodes matrix: ${nodes}"

  e2e-test:
    runs-on: ubuntu-24.04
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        ginkgo_node: ${{ fromJson(needs.generate-matrix.outputs.nodes) }}
    env:
      DOCKER_BUILDKIT: 1
      BUILDKIT_PROGRESS: plain
      FLIGHTCTL_NS: flightctl-external
    steps:
      # ========== PREPARE ENVIRONMENT ==========
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android >/dev/null 2>&1 &
          echo "Started background removal of /usr/local/lib/android (PID: $!)"
          df -h

      # ========== SETUP DEPENDENCIES ==========
      - name: Setup dependencies (KVM, libvirt, etc)
        uses: ./.github/actions/setup-dependencies
        with:
          setup_kvm: yes

      - name: Post-setup verification
        run: |
          echo "*** E2E: POST-SETUP VERIFICATION ***"
          echo "*** E2E: CHECKING GO VERSION ***"
          go version || echo "GO NOT AVAILABLE"
          echo "*** E2E: CHECKING DOCKER ***"
          docker version || echo "DOCKER NOT AVAILABLE"
          docker info || echo "DOCKER INFO FAILED"
          echo "*** E2E: CHECKING KIND ***"
          kind version || echo "KIND NOT AVAILABLE"
          echo "*** E2E: CHECKING KUBECTL ***"
          kubectl version --client || echo "KUBECTL NOT AVAILABLE"
          echo "*** E2E: CHECKING HELM ***"
          helm version || echo "HELM NOT AVAILABLE"
          echo "*** E2E: POST-SETUP VERIFICATION COMPLETE ***"

      - name: Compute base domain
        id: base-domain
        run: |
          echo "*** E2E: STARTING BASE DOMAIN COMPUTATION ***"
          echo "*** E2E: CHECKING NETWORK CONNECTIVITY ***"
          ping -c 1 1.1.1.1 || echo "PING TO 1.1.1.1 FAILED"

          echo "*** E2E: CHECKING IP ROUTE ***"
          ip route get 1.1.1.1 || { echo "IP ROUTE FAILED"; exit 1; }

          echo "*** E2E: EXTRACTING IP ADDRESS ***"
          IP=$(ip route get 1.1.1.1 | grep -oP 'src \K\S+')
          echo "*** E2E: EXTRACTED IP: '$IP' ***"

          if [ -z "$IP" ]; then
            echo "*** E2E: ERROR - IP EXTRACTION FAILED ***"
            echo "*** E2E: IP ROUTE OUTPUT: ***"
            ip route get 1.1.1.1
            exit 1
          fi

          BASE_DOMAIN="${IP}.nip.io"
          echo "*** E2E: COMPUTED BASE DOMAIN: '$BASE_DOMAIN' ***"

          echo "ip=${IP}" >> "$GITHUB_OUTPUT"
          echo "base_domain=${BASE_DOMAIN}" >> "$GITHUB_OUTPUT"
          echo "*** E2E: BASE DOMAIN COMPUTATION COMPLETE ***"

      # ========== DEPLOY BACKEND WITH HELM ==========
      - name: Pre-deployment validation
        run: |
          echo "*** E2E: PRE-DEPLOYMENT VALIDATION ***"
          echo "*** E2E: VALIDATING INPUTS ***"
          echo "tag: '${{ inputs.tag }}'"
          echo "base-domain: '${{ steps.base-domain.outputs.base_domain }}'"
          echo "flavor: '${{ inputs.flavor }}'"
          echo "ginkgo_node: '${{ matrix.ginkgo_node }}'"
          echo "display-summary: '${{ matrix.ginkgo_node == 1 }}'"

          echo "*** E2E: CHECKING REQUIRED FILES ***"
          echo "Kind config file:"
          ls -la test/scripts/kind_cluster.yaml || echo "KIND CONFIG NOT FOUND"
          if [ -f test/scripts/kind_cluster.yaml ]; then
            echo "*** E2E: KIND CONFIG CONTENT ***"
            cat test/scripts/kind_cluster.yaml
          fi

          echo "E2E values file:"
          ls -la deploy/helm/flightctl/values.e2e.yaml || echo "E2E VALUES FILE NOT FOUND"
          if [ -f deploy/helm/flightctl/values.e2e.yaml ]; then
            echo "*** E2E: VALUES FILE CONTENT ***"
            head -20 deploy/helm/flightctl/values.e2e.yaml
          fi

          echo "*** E2E: CHECKING WORKING DIRECTORY ***"
          pwd
          ls -la . | head -10
          echo "*** E2E: PRE-DEPLOYMENT VALIDATION COMPLETE ***"

      - name: Deploy backend with Helm
        id: deploy-backend
        uses: ./.github/actions/deploy-backend-with-helm
        with:
          tag: ${{ inputs.tag }}
          base-domain: ${{ steps.base-domain.outputs.base_domain }}
          additional-values-files: deploy/helm/flightctl/values.e2e.yaml
          auth-type: k8s
          kind-config: test/scripts/kind_cluster.yaml
          display-summary: ${{ matrix.ginkgo_node == 1 }}
          wait: false
          flavor: ${{ inputs.flavor }}

      - name: Post-deployment verification
        run: |
          echo "*** E2E: POST-DEPLOYMENT VERIFICATION ***"
          echo "*** E2E: CHECKING HELM RELEASES ***"
          helm list -A || echo "HELM LIST FAILED"

          echo "*** E2E: CHECKING CLUSTER STATE ***"
          kubectl get nodes || echo "GET NODES FAILED"
          kubectl get namespaces | grep flightctl || echo "NO FLIGHTCTL NAMESPACES"

          echo "*** E2E: CHECKING FLIGHTCTL PODS ***"
          kubectl get pods -A | grep flightctl || echo "NO FLIGHTCTL PODS"

          echo "*** E2E: CHECKING FLIGHTCTL SERVICES ***"
          kubectl get services -A | grep flightctl || echo "NO FLIGHTCTL SERVICES"

          echo "*** E2E: CHECKING KIND CLUSTER ***"
          kind get clusters || echo "NO KIND CLUSTERS"

          echo "*** E2E: POST-DEPLOYMENT VERIFICATION COMPLETE ***"

      # ========== DOWNLOAD E2E TEST ARTIFACTS ==========
      - name: Debug E2E artifact download parameters
        run: |
          echo "*** E2E: ARTIFACT DOWNLOAD PARAMETERS ***"
          echo "os_id: '${{ inputs.os_id }}'"
          echo "tag: '${{ inputs.tag }}'"
          echo "pattern: 'agent-*-${{ inputs.os_id }}-${{ inputs.tag }}'"
          echo "*** E2E: ARTIFACT DOWNLOAD PARAMETERS COMPLETE ***"

      - name: Download test artifacts
        id: download-test-artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: agent-*-${{ inputs.os_id }}-${{ inputs.tag }}
          path: test-artifacts
          merge-multiple: true

      - name: Stage test artifacts
        run: |
          echo "*** E2E: STAGING TEST ARTIFACTS ***"
          echo "*** E2E: DOWNLOAD OUTCOME: ${{ steps.download-test-artifacts.outcome }} ***"

          if [ "${{ steps.download-test-artifacts.outcome }}" != "success" ]; then
            echo "*** E2E: ARTIFACT DOWNLOAD FAILED ***"
            echo "*** E2E: CHECKING WORKSPACE ***"
            ls -la . || true
            echo "*** E2E: NO ARTIFACTS AVAILABLE FOR STAGING ***"
            exit 1
          fi

          set -euo pipefail
          echo "*** E2E: ARTIFACT DOWNLOAD SUCCEEDED ***"
          echo "*** E2E: DOWNLOADED TEST ARTIFACTS ***"
          ls -la test-artifacts || echo "NO TEST-ARTIFACTS DIRECTORY"
          tree test-artifacts || echo "TREE FAILED - USING LS"
          find test-artifacts -type f || echo "NO FILES IN TEST-ARTIFACTS"

          # Stage agent bundle
          mkdir -p bin/agent-artifacts
          if [ ! -f "test-artifacts/agent-images-bundle-${{ inputs.os_id }}.tar" ]; then
            echo "ERROR: Agent bundle not found"
            exit 1
          fi
          mv "test-artifacts/agent-images-bundle-${{ inputs.os_id }}.tar" bin/agent-artifacts/
          echo "‚úì Agent bundle: bin/agent-artifacts/agent-images-bundle-${{ inputs.os_id }}.tar"

          # Stage qcow2
          mkdir -p bin/output/qcow2
          if [ ! -f "test-artifacts/disk.qcow2" ]; then
            echo "ERROR: QCOW2 image not found"
            exit 1
          fi
          mv "test-artifacts/disk.qcow2" bin/output/qcow2/
          echo "‚úì QCOW2 image: bin/output/qcow2/disk.qcow2"

          # Cleanup
          rm -rf test-artifacts

          echo "Staged artifacts:"
          tree bin
          df -h

      # ========== PREP E2E ENV ==========
      - name: Load API readiness timeout configuration
        id: api-timeout
        run: |
          set -euo pipefail

          CHART_OPTS_FILE="deploy/helm/helm-chart-opts.yaml"
          FLAVOR_KEY="community-${{ inputs.flavor }}"

          if [ ! -f "$CHART_OPTS_FILE" ]; then
            echo "ERROR: Chart options file not found: $CHART_OPTS_FILE"
            exit 1
          fi

          # Extract API readiness timeout using yq
          API_READINESS_TIMEOUT=$(yq eval ".${FLAVOR_KEY}.timeouts.apiReadiness" "$CHART_OPTS_FILE")

          # Validate timeout value
          if [ "$API_READINESS_TIMEOUT" == "null" ]; then
            echo "ERROR: Failed to load API readiness timeout for flavor ${{ inputs.flavor }}"
            exit 1
          fi

          echo "API readiness timeout for ${{ inputs.flavor }}: ${API_READINESS_TIMEOUT}s (from $CHART_OPTS_FILE)"
          echo "timeout=${API_READINESS_TIMEOUT}" >> "$GITHUB_OUTPUT"

      - name: Wait for API readiness
        uses: ./.github/actions/wait-for-api-readiness
        with:
          base-domain: ${{ steps.base-domain.outputs.base_domain }}
          # Timeout loaded from helm-chart-opts.yaml based on flavor
          retries: ${{ steps.api-timeout.outputs.timeout }}

      - name: Prepare E2E environment
        env:
          AGENT_OS_ID: ${{ inputs.os_id }}
        run: |
          # prepare-e2e-test handles the full dependency chain:
          #   - deploy-e2e-extras (registry)
          #   - build-e2e-containers
          #   - push-e2e-agent-images (detects existing bundles, won't rebuild)
          #   - prepare-e2e-qcow-config -> bin/.e2e-agent-injected -> bin/.e2e-agent-certs
          # All dependencies are resolved automatically by Make
          make prepare-e2e-test

      # ========== RUN E2E TESTS ==========
      - name: Pre-test validation
        run: |
          echo "*** E2E: PRE-TEST VALIDATION ***"
          echo "*** E2E: CHECKING CLUSTER READINESS ***"
          kubectl get nodes || echo "NO CLUSTER NODES"
          kubectl get pods -A | grep flightctl || echo "NO FLIGHTCTL PODS"

          echo "*** E2E: CHECKING TEST ENVIRONMENT ***"
          echo "ginkgo_label_filter: '${{ inputs.ginkgo_label_filter }}'"
          echo "ginkgo_node: '${{ matrix.ginkgo_node }}'"
          echo "ginkgo_node_count: '${{ inputs.ginkgo_node_count }}'"

          echo "*** E2E: CHECKING TEST BINARIES ***"
          ls -la bin/ || echo "NO BIN DIRECTORY"
          ls -la bin/agent-artifacts/ || echo "NO AGENT ARTIFACTS"
          ls -la bin/output/qcow2/ || echo "NO QCOW2 IMAGES"

          echo "*** E2E: PRE-TEST VALIDATION COMPLETE ***"

      - name: Restore Go cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Compute label filter hash
        id: compute-hash
        run: |
          echo "*** E2E: COMPUTING LABEL FILTER HASH ***"
          HASH=$(printf '%s' "${{ inputs.ginkgo_label_filter }}" | sha256sum | cut -c1-8)
          echo "hash=${HASH}" >> "$GITHUB_OUTPUT"
          echo "*** E2E: Label filter: '${{ inputs.ginkgo_label_filter }}' ***"
          echo "*** E2E: Hash: ${HASH} ***"

      - name: Download test discovery
        uses: actions/download-artifact@v4
        with:
          name: e2e-discovery-${{ steps.compute-hash.outputs.hash }}-${{ inputs.tag }}
          path: .

      - name: Check disk space
        run: df -h

      - name: Run E2E Test Slice
        env:
          GINKGO_LABEL_FILTER: ${{ inputs.ginkgo_label_filter }}
          GINKGO_TOTAL_NODES: ${{ inputs.ginkgo_total_nodes }}
          GINKGO_NODE: ${{ matrix.ginkgo_node }}
          DISCOVERY_PATH: discovery.json
        run: |
          if [[ "${{ runner.debug }}" == "1" ]]; then
            echo "üêõ Debug mode enabled"
            export DEBUG_VM_CONSOLE=1
            export VERBOSE=true
          else
            echo "Debug mode disabled"
          fi
          make -e run-e2e-test

      - name: Check disk space after E2E tests
        if: always()
        run: df -h

      # ========== UPLOAD TEST RESULTS ==========
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results-${{ inputs.os_id }}-${{ inputs.flavor }}-${{ steps.compute-hash.outputs.hash }}-node-${{ matrix.ginkgo_node }}
          path: reports/junit_e2e_test.xml
          if-no-files-found: warn
          overwrite: true

      # ========== COLLECT LOGS ==========
      - name: Collect and Upload Logs
        if: always()
        uses: ./.github/actions/collect-logs
        with:
          namespace-external: 'flightctl-external'
          namespace-internal: 'flightctl-internal'
          log-directory: 'e2e-logs-${{ inputs.os_id }}-${{ inputs.flavor }}-${{ steps.compute-hash.outputs.hash }}-node-${{ matrix.ginkgo_node }}-logs'
