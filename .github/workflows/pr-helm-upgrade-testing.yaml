name: "Helm upgrade test"

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'release-*'
  pull_request:

permissions:
  contents: read
  pull-requests: read

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  QUAY_ORG: quay.io/flightctl
  REGISTRY: quay.io
  REGISTRY_OWNER: flightctl
  REGISTRY_OWNER_TESTS: flightctl-tests
  GITHUB_ACTIONS: true

jobs:
  check-changes:
    runs-on: ubuntu-24.04
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          since_last_remote_commit: 'true'
          files_ignore: |
            .spelling
            README.md
            docs/**
            examples/**
            packaging/rpm/**

  build-baseline:
    needs: check-changes
    if: needs.check-changes.outputs.any_changed == 'true'
    uses: ./.github/workflows/build-images-and-charts.yaml
    with:
      repository: flightctl/flightctl
      ref: main

  build-pr-branch:
    needs: check-changes
    if: needs.check-changes.outputs.any_changed == 'true'
    uses: ./.github/workflows/build-images-and-charts.yaml

  deploy-and-upgrade:
    runs-on: ubuntu-24.04
    needs: [check-changes, build-baseline, build-pr-branch]
    if: needs.check-changes.outputs.any_changed == 'true'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Free disk space (in background)
        run: |
          sudo rm -rf /usr/local/lib/android >/dev/null 2>&1 &
          echo "Started background removal of /usr/local/lib/android (PID: $!)"
          df -h

      # ========== DEPLOY BASELINE (main branch) ==========
      - name: Deploy baseline using composite action
        uses: ./.github/actions/deploy-backend-with-helm
        with:
          tag: ${{ needs.build-baseline.outputs.git_tag }}

      - name: Get base domain
        id: get-ip
        run: |
          source ./test/scripts/functions
          BASE_DOMAIN=$(get_ext_ip).nip.io
          echo "$BASE_DOMAIN"
          echo "base-domain=$BASE_DOMAIN" >> "$GITHUB_OUTPUT"

      - name: Check baseline deployment
        run: kubectl get pods --all-namespaces

      - name: Login to baseline
        env:
          BASE_DOMAIN: ${{ steps.get-ip.outputs.base-domain }}
        run: |
          # Login to the API (no auth by default, matching deploy_with_helm.sh)
          for i in {1..60}; do
            if ./bin/flightctl login -k https://api.${BASE_DOMAIN}:3443; then
              echo "Successfully logged in to baseline"
              ./bin/flightctl version
              break
            fi
            echo "Login attempt $i failed, retrying..."
            sleep 5
          done

      - name: Apply test resources to baseline
        run: |
          bin/flightctl apply -f examples/device.yaml
          bin/flightctl apply -f examples/fleet.yaml
          bin/flightctl apply -f examples/enrollmentrequest.yaml
          bin/flightctl apply -f examples/repository-flightctl.yaml
          bin/flightctl apply -f examples/resourcesync.yaml

      - name: Run baseline simulator
        run: |
          make prepare-agent-config
          DISABLE_FIPS="true" make build-devicesimulator
          bin/devicesimulator --config bin/agent/etc/flightctl/config.yaml --count 1 --stop-after 1m

      # ========== UPGRADE TO PR BRANCH ==========
      - name: Download PR branch artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ needs.build-pr-branch.outputs.git_tag }}"
          path: artifacts-pr
          merge-multiple: true

      - name: Load PR branch images into kind
        run: |
          set -euo pipefail
          echo "Loading PR branch backend images into kind"
          kind load image-archive artifacts-pr/flightctl-images-bundle.tar
          echo "PR images loaded successfully"
          rm -f artifacts-pr/flightctl-images-bundle.tar

      - name: Setup PR branch CLI binary
        run: |
          set -euo pipefail
          mkdir -p bin-pr
          mv artifacts-pr/flightctl-linux-amd64 bin-pr/flightctl
          chmod +x bin-pr/flightctl
          echo "PR branch CLI version:"
          bin-pr/flightctl version

      - name: Install helm diff plugin
        run: |
          helm plugin install https://github.com/databus23/helm-diff || true
          helm plugin list

      - name: Show helm diff before upgrade
        env:
          BASE_DOMAIN: ${{ steps.get-ip.outputs.base-domain }}
        run: |
          CHART_FILE="artifacts-pr/flightctl-chart.tgz"
          
          echo "::group::Helm diff - changes to be applied"
          helm diff upgrade flightctl "${CHART_FILE}" \
            --namespace flightctl-external \
            --set global.baseDomain=${BASE_DOMAIN} \
            --set global.internalNamespace=flightctl-internal \
            --set global.target=standalone \
            --set global.exposeServicesMethod=nodePort \
            --context kind-kind || true
          echo "::endgroup::"

      - name: Helm upgrade to PR branch
        env:
          BASE_DOMAIN: ${{ steps.get-ip.outputs.base-domain }}
        run: |
          ( kubectl get pods --all-namespaces -w | sed 's/^/[cluster upgrade] /' ) &

          CHART_FILE="artifacts-pr/flightctl-chart.tgz"

          # Use same global params as deploy_with_helm.sh
          helm upgrade flightctl "${CHART_FILE}" \
            --namespace flightctl-external \
            --set global.baseDomain=${BASE_DOMAIN} \
            --set global.internalNamespace=flightctl-internal \
            --set global.target=standalone \
            --set global.exposeServicesMethod=nodePort \
            --context kind-kind \
            --debug --wait

      - name: Check the upgraded deployment
        run: |
          helm list --all-namespaces
          kubectl get pods --all-namespaces

      - name: Login with PR branch CLI after upgrade
        env:
          BASE_DOMAIN: ${{ steps.get-ip.outputs.base-domain }}
        run: |
          # Login to the API after upgrade
          for i in {1..60}; do
            if ./bin-pr/flightctl login -k https://api.${BASE_DOMAIN}:3443; then
              echo "Successfully logged in after upgrade"
              echo "PR CLI version:"
              ./bin-pr/flightctl version
              echo ""
              echo "Client config:"
              cat ~/.config/flightctl/client.yaml || true
              break
            fi
            echo "Login attempt $i failed, retrying..."
            sleep 5
          done

      - name: Verify resources after upgrade
        run: |
          ./bin-pr/flightctl get dev
          ./bin-pr/flightctl get fleet
          ./bin-pr/flightctl get er
          ./bin-pr/flightctl get repo
          ./bin-pr/flightctl get rs

      - name: Run simulator with PR branch
        run: |
          DISABLE_FIPS="true" make build-devicesimulator
          bin/devicesimulator --config bin/agent/etc/flightctl/config.yaml --count 1 --stop-after 1m

      - name: Collect and Upload Logs
        if: always()
        uses: ./.github/actions/collect-logs
        with:
          namespace-external: 'flightctl-external'
          namespace-internal: 'flightctl-internal'
          log-directory: 'upgrade-logs'
