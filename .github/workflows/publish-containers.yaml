
name: Push to main

on:
  push:
    branches:
      - main
      - 'release-*'
    tags:
      - '*'

env:
  QUAY_ORG: quay.io/flightctl
  QUAY_CHARTS: quay.io/flightctl/charts
  # Enable BuildKit for cache mounts
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  generate-tags:
    runs-on: "ubuntu-24.04"
    outputs:
      image_tags: ${{ steps.get-tags.outputs.image_tags }}
      helm_tag: ${{ steps.get-tags.outputs.helm_tag }}
      helm_ui_image_tag: ${{ steps.get-tags.outputs.helm_ui_image_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Generate version tag
        id: get-tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if ${{ github.ref_type == 'tag' }}; then
            # The images tags will match the Release tag
            image_tags=( ${{ github.ref_name }} )
            # image tags should not have the leading v, and we tag rcs with ~rc1..rcX for rpm version ordering
            image_tags=$(echo "${image_tags#v}" | sed 's/~/-/g')

            echo "image_tags=${image_tags[@]}" >> $GITHUB_OUTPUT
            echo "helm_tag=${image_tags[@]}" >> $GITHUB_OUTPUT
            echo "image_tags,helm_tag=${image_tags[@]}"

          else
            version=$(./hack/current-version)
            # image tags should not have the leading v, and we tag rcs with ~rc1..rcX for rpm version ordering
            version=$(echo "${version#v}" | sed 's/~/-/g')

            # if the branch is main, we tag the image as latest, otherwise release-0.x
            if ${{ github.ref_name == 'main' }}; then
              latest_tag="latest"
            else
              latest_tag="${{ github.ref_name }}"
            fi

            # The images tags are taken from git
            image_tags=( ${latest_tag}-${GITHUB_SHA} ${latest_tag} ${version} cache )
            echo "image_tags=${image_tags[@]}" >> $GITHUB_OUTPUT
            echo "image_tags=${image_tags[@]}"

            helm_tag=${version} # remove the leading v prefix for version
            echo "helm_tag=${helm_tag}" >> $GITHUB_OUTPUT
            echo "helm_tag=${helm_tag}"

            UI_SHA=$(gh api repos/flightctl/flightctl-ui/commits/main --jq .sha)
            if [ -z "$UI_SHA" ]; then
              echo "Error: Failed to fetch UI commit SHA from flightctl-ui repository"
              exit 1
            fi
            helm_ui_image_tag="latest-$UI_SHA"
            echo "helm_ui_image_tag=${helm_ui_image_tag}" >> $GITHUB_OUTPUT
            echo "helm_ui_image_tag=${helm_ui_image_tag}"
          fi

  publish-helm-charts-containers:
    runs-on: "ubuntu-24.04"
    needs: [publish-flightctl-containers, generate-tags]
    steps:
      - uses: actions/checkout@v4

      - name: Setup all dependencies
        uses: ./.github/actions/setup-dependencies

      - name: Build helm charts
        run: |
          echo packaging "${{ needs.generate-tags.outputs.helm_tag }}"

          if [ -n "${{ needs.generate-tags.outputs.helm_ui_image_tag }}" ]; then
            echo "Updating ui.image.tag to ${{ needs.generate-tags.outputs.helm_ui_image_tag }}"
            yq -i '.ui.image.tag = "${{ needs.generate-tags.outputs.helm_ui_image_tag }}"' deploy/helm/flightctl/values.yaml
          fi

          helm package ./deploy/helm/flightctl \
              --version "${{ needs.generate-tags.outputs.helm_tag }}" \
              --app-version "${{ needs.generate-tags.outputs.helm_tag }}"

      - name: Login helm
        env:
          PASSWORD: ${{ secrets.QUAY_FLIGHTCTL_INFRA_ROBOT_PASSWORD }}
          USER: ${{ secrets.QUAY_FLIGHTCTL_INFRA_ROBOT_USERNAME }}
        run:
          helm registry login quay.io -u ${USER} -p ${PASSWORD}

      - name: Push helm charts
        run: |
          helm push "flightctl-${{ needs.generate-tags.outputs.helm_tag }}.tgz" oci://${{ env.QUAY_CHARTS }}/

  publish-flightctl-containers:
    strategy:
      matrix:
        image: ['api', 'pam-issuer', 'periodic', 'worker', 'cli-artifacts', 'alert-exporter', 'alertmanager-proxy', 'userinfo-proxy', 'db-setup', 'telemetry-gateway', 'imagebuilder-api', 'imagebuilder-worker']
    needs: [generate-tags]
    runs-on: "ubuntu-24.04"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Prepare version variables
        id: version-vars
        run: |
          set -euo pipefail
          SOURCE_GIT_TAG=$(./hack/current-version)
          if [ ! -d ".git" ]; then
            SOURCE_GIT_TREE_STATE=clean
          elif git diff --quiet; then
            SOURCE_GIT_TREE_STATE=clean
          else
            SOURCE_GIT_TREE_STATE=dirty
          fi
          SOURCE_GIT_COMMIT=$(git rev-parse --short "HEAD^{commit}" 2>/dev/null || echo "unknown")

          {
            echo "git_tag=${SOURCE_GIT_TAG}"
            echo "git_tree_state=${SOURCE_GIT_TREE_STATE}"
            echo "git_commit=${SOURCE_GIT_COMMIT}"
          } >> "$GITHUB_OUTPUT"

          echo "Calculated version variables:"
          echo "  SOURCE_GIT_TAG: ${SOURCE_GIT_TAG}"
          echo "  SOURCE_GIT_TREE_STATE: ${SOURCE_GIT_TREE_STATE}"
          echo "  SOURCE_GIT_COMMIT: ${SOURCE_GIT_COMMIT}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.4

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Cache DNF packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/dnf
            /var/lib/dnf
          key: ${{ runner.os }}-dnf-${{ matrix.image }}
          restore-keys: |
            ${{ runner.os }}-dnf-

      - name: Build
        id: build
        uses: redhat-actions/buildah-build@v2
        with:
          image: flightctl-${{ matrix.image }}
          tags: ${{ needs.generate-tags.outputs.image_tags }}
          labels: |
            io.flightctl.flightctl-${{ matrix.image }}.github.repository=${{ github.repository }}
            io.flightctl.flightctl-${{ matrix.image }}.github.actor=${{ github.actor }}
            io.flightctl.flightctl-${{ matrix.image }}.github.run_id=${{ github.run_id }}
            io.flightctl.flightctl-${{ matrix.image }}.github.sha=${{ github.sha }}
            io.flightctl.flightctl-${{ matrix.image }}.github.ref_name=${{ github.ref_name }}
          build-args: |
            SOURCE_GIT_TAG=${{ steps.version-vars.outputs.git_tag }}
            SOURCE_GIT_TREE_STATE=${{ steps.version-vars.outputs.git_tree_state }}
            SOURCE_GIT_COMMIT=${{ steps.version-vars.outputs.git_commit }}
          extra-args: |
            --ulimit nofile=10000:10000
          containerfiles: Containerfile.${{ matrix.image }}
          context: .

      - name: Validate FIPS
        id: fips
        run: |
          go install github.com/flightctl/fips-validator@latest
          TAGS=(${{ steps.build.outputs.tags }})
          podman unshare -- $HOME/go/bin/fips-validator image ${{ steps.build.outputs.image }}:${TAGS[0]}

      - name: Push to Quay.io
        id: push
        uses: redhat-actions/push-to-registry@v2.7
        with:
          image: ${{ steps.build.outputs.image }}
          tags: ${{ steps.build.outputs.tags }}
          registry: ${{ env.QUAY_ORG }}
          username: ${{ secrets.QUAY_FLIGHTCTL_INFRA_ROBOT_USERNAME }}
          password: ${{ secrets.QUAY_FLIGHTCTL_INFRA_ROBOT_PASSWORD }}
