openapi: 3.0.1
info:
  title: Flight Control Image Builder API
  version: v1beta1
  description: |
    Image Builder service for Flight Control.
    This service manages image build resources for building and pushing container images.
  contact:
    name: The Flight Control Team
    url: https://flightctl.io
    email: team@flightctl.io
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
servers:
  - url: /
tags:
  - name: imagebuild
    description: Operations on ImageBuild resources.
  - name: imageexport
    description: Operations on ImageExport resources.
  - name: imagepipeline
    description: Operations on ImagePipeline (atomic ImageBuild + ImageExport creation).
# Note: Security is handled by Chi middleware (auth.CreateAuthNMiddleware), not OpenAPI validation
# The securitySchemes are defined in components for documentation purposes
paths:
  /api/v1/imagebuilds:
    get:
      tags:
        - imagebuild
      description: List ImageBuild resources.
      operationId: listImageBuilds
      parameters:
        - name: labelSelector
          in: query
          description: A selector to restrict the list of returned objects by their labels.
          schema:
            type: string
        - name: fieldSelector
          in: query
          description: A selector to restrict the list of returned objects by their fields.
          schema:
            type: string
        - name: limit
          in: query
          description: The maximum number of results returned in the list response.
          schema:
            type: integer
            format: int32
        - name: continue
          in: query
          description: An optional parameter to query more results from the server.
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageBuildList'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
    post:
      tags:
        - imagebuild
      description: Create an ImageBuild resource.
      operationId: createImageBuild
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImageBuild'
        required: true
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageBuild'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "409":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
  /api/v1/imagebuilds/{name}:
    get:
      tags:
        - imagebuild
      description: Get an ImageBuild resource.
      operationId: getImageBuild
      parameters:
        - name: name
          in: path
          description: The name of the ImageBuild resource.
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageBuild'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
    delete:
      tags:
        - imagebuild
      description: Delete an ImageBuild resource.
      operationId: deleteImageBuild
      parameters:
        - name: name
          in: path
          description: The name of the ImageBuild resource.
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageBuild'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
  /api/v1/imagepipelines:
    post:
      tags:
        - imagepipeline
      description: Create an ImagePipeline consisting of an ImageBuild and optionally an ImageExport atomically in a single transaction.
      operationId: createImagePipeline
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImagePipelineRequest'
        required: true
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImagePipelineResponse'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "409":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
  /api/v1/imageexports:
    get:
      tags:
        - imageexport
      description: List ImageExport resources.
      operationId: listImageExports
      parameters:
        - name: labelSelector
          in: query
          description: A selector to restrict the list of returned objects by their labels.
          schema:
            type: string
        - name: fieldSelector
          in: query
          description: A selector to restrict the list of returned objects by their fields.
          schema:
            type: string
        - name: limit
          in: query
          description: The maximum number of results returned in the list response.
          schema:
            type: integer
            format: int32
        - name: continue
          in: query
          description: An optional parameter to query more results from the server.
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageExportList'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
    post:
      tags:
        - imageexport
      description: Create an ImageExport resource.
      operationId: createImageExport
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImageExport'
        required: true
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageExport'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "409":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
  /api/v1/imageexports/{name}:
    get:
      tags:
        - imageexport
      description: Get an ImageExport resource.
      operationId: getImageExport
      parameters:
        - name: name
          in: path
          description: The name of the ImageExport resource.
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageExport'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
    delete:
      tags:
        - imageexport
      description: Delete an ImageExport resource.
      operationId: deleteImageExport
      parameters:
        - name: name
          in: path
          description: The name of the ImageExport resource.
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageExport'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "429":
          description: Too Many Requests
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Status'
components:
  securitySchemes:
    bearerAuth:
      $ref: '../openapi.yaml#/components/securitySchemes/bearerAuth'
    orgId:
      $ref: '../openapi.yaml#/components/securitySchemes/orgId'
  schemas:
    ImageBuild:
      type: object
      description: ImageBuild represents a build request for a container image.
      properties:
        apiVersion:
          type: string
          description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources.'
        kind:
          type: string
          description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds.'
        metadata:
          $ref: '../openapi.yaml#/components/schemas/ObjectMeta'
        spec:
          $ref: '#/components/schemas/ImageBuildSpec'
        status:
          $ref: '#/components/schemas/ImageBuildStatus'
      required:
        - apiVersion
        - kind
        - metadata
        - spec

    ImageBuildList:
      type: object
      description: ImageBuildList is a list of ImageBuild resources.
      properties:
        apiVersion:
          type: string
          description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources.'
        kind:
          type: string
          description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds.'
        metadata:
          $ref: '../openapi.yaml#/components/schemas/ListMeta'
        items:
          type: array
          description: 'List of ImageBuild resources.'
          items:
            $ref: '#/components/schemas/ImageBuild'
      required:
        - apiVersion
        - kind
        - metadata
        - items

    ImageBuildSpec:
      type: object
      description: ImageBuildSpec describes the specification for an image build.
      properties:
        source:
          $ref: '#/components/schemas/ImageBuildSource'
        destination:
          $ref: '#/components/schemas/ImageBuildDestination'
        binding:
          $ref: '#/components/schemas/ImageBuildBinding'
      required:
        - source
        - destination
        - binding

    ImageBuildSource:
      type: object
      description: ImageBuildSource specifies the source image for the build.
      properties:
        repository:
          type: string
          description: The name of the Repository resource of type OCI containing the source image.
        imageName:
          type: string
          description: The name of the source image.
        imageTag:
          type: string
          description: The tag of the source image.
      required:
        - repository
        - imageName
        - imageTag

    ImageBuildDestination:
      type: object
      description: ImageBuildDestination specifies the destination for the built image.
      properties:
        repository:
          type: string
          description: The name of the Repository resource of type OCI to push the built image to.
        imageName:
          type: string
          description: The name of the output image.
        tag:
          type: string
          description: The tag of the output image.
      required:
        - repository
        - imageName
        - tag

    ImageBuildBinding:
      description: ImageBuildBinding specifies binding configuration for the build.
      oneOf:
        - $ref: '#/components/schemas/EarlyBinding'
        - $ref: '#/components/schemas/LateBinding'
      discriminator:
        propertyName: type
        mapping:
          early: '#/components/schemas/EarlyBinding'
          late: '#/components/schemas/LateBinding'

    EarlyBinding:
      type: object
      description: Early binding configuration - embeds certificate in the image.
      required:
        - type
        - certName
      properties:
        type:
          type: string
          enum: [early]
          description: The type of binding.
        certName:
          type: string
          description: Name of the enrollment certificate resource to embed in the image for device binding.

    LateBinding:
      type: object
      description: Late binding configuration - device binds at first boot.
      required:
        - type
      properties:
        type:
          type: string
          enum: [late]
          description: The type of binding.

    BindingType:
      type: string
      description: The type of binding for the image build.
      enum:
        - early
        - late
      x-enum-varnames:
        - BindingTypeEarly
        - BindingTypeLate

    ImageBuildStatus:
      type: object
      description: ImageBuildStatus represents the current status of an ImageBuild.
      properties:
        conditions:
          type: array
          description: Current conditions of the ImageBuild.
          items:
            $ref: '#/components/schemas/ImageBuildCondition'
        imageReference:
          type: string
          description: The full image reference of the built image (e.g., quay.io/org/imagename:tag).
        architecture:
          type: string
          description: The architecture of the built image.
        manifestDigest:
          type: string
          description: The digest of the built image manifest.
        lastSeen:
          type: string
          format: date-time
          description: The last time the build was seen (heartbeat).

    ImageBuildCondition:
      description: Condition for ImageBuild resources.
      allOf:
        - $ref: '../openapi.yaml#/components/schemas/ConditionBase'
        - type: object
          required:
            - type
          properties:
            type:
              $ref: '#/components/schemas/ImageBuildConditionType'
    ImageBuildConditionType:
      type: string
      description: Type of ImageBuild condition.
      enum:
        - Ready
      x-enum-varnames:
        - ImageBuildConditionTypeReady
    ImageBuildConditionReason:
      type: string
      description: Reason for the ImageBuild Ready condition.
      enum:
        - Pending
        - Building
        - Pushing
        - Completed
        - Failed
      x-enum-varnames:
        - ImageBuildConditionReasonPending
        - ImageBuildConditionReasonBuilding
        - ImageBuildConditionReasonPushing
        - ImageBuildConditionReasonCompleted
        - ImageBuildConditionReasonFailed
    # ImageExport schemas
    ImageExport:
      type: object
      description: ImageExport represents an export request to convert and push images to different formats.
      properties:
        apiVersion:
          type: string
          description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources.'
        kind:
          type: string
          description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds.'
        metadata:
          $ref: '../openapi.yaml#/components/schemas/ObjectMeta'
        spec:
          $ref: '#/components/schemas/ImageExportSpec'
        status:
          $ref: '#/components/schemas/ImageExportStatus'
      required:
        - apiVersion
        - kind
        - metadata
        - spec

    ImageExportList:
      type: object
      description: ImageExportList is a list of ImageExport resources.
      properties:
        apiVersion:
          type: string
          description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources.'
        kind:
          type: string
          description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds.'
        metadata:
          $ref: '../openapi.yaml#/components/schemas/ListMeta'
        items:
          type: array
          description: 'List of ImageExport resources.'
          items:
            $ref: '#/components/schemas/ImageExport'
      required:
        - apiVersion
        - kind
        - metadata
        - items

    ImageExportSpec:
      type: object
      description: ImageExportSpec describes the specification for an image export.
      properties:
        source:
          $ref: '#/components/schemas/ImageExportSource'
        destination:
          $ref: '#/components/schemas/ImageExportDestination'
        format:
          $ref: '#/components/schemas/ExportFormatType'
        tagSuffix:
          type: string
          description: Optional suffix to append to the output tag for this format.
      required:
        - source
        - destination
        - format

    ImageExportSource:
      description: ImageExportSource specifies the source image for the export.
      oneOf:
        - $ref: '#/components/schemas/ImageBuildRefSource'
        - $ref: '#/components/schemas/ImageReferenceSource'
      discriminator:
        propertyName: type
        mapping:
          imageBuild: '#/components/schemas/ImageBuildRefSource'
          imageReference: '#/components/schemas/ImageReferenceSource'

    ImageBuildRefSource:
      type: object
      description: ImageBuildRefSource specifies a source image from an ImageBuild resource.
      required:
        - type
        - imageBuildRef
      properties:
        type:
          type: string
          enum: [imageBuild]
          description: The type of source.
        imageBuildRef:
          type: string
          description: The name of the ImageBuild resource to use as source.

    ImageReferenceSource:
      type: object
      description: ImageReferenceSource specifies a source image from a repository.
      required:
        - type
        - repository
        - imageName
        - imageTag
      properties:
        type:
          type: string
          enum: [imageReference]
          description: The type of source.
        repository:
          type: string
          description: The name of the Repository resource containing the source image.
        imageName:
          type: string
          description: The name of the source image.
        imageTag:
          type: string
          description: The tag of the source image.

    ImageExportSourceType:
      type: string
      description: The type of source for the image export.
      enum:
        - imageBuild
        - imageReference
      x-enum-varnames:
        - ImageExportSourceTypeImageBuild
        - ImageExportSourceTypeImageReference

    ImageExportDestination:
      type: object
      description: ImageExportDestination specifies the destination for the exported images.
      properties:
        repository:
          type: string
          description: The name of the Repository resource to push the exported images to.
        imageName:
          type: string
          description: The name of the destination image.
        tag:
          type: string
          description: The base tag for the destination images.
      required:
        - repository
        - imageName
        - tag
    ExportFormatType:
      type: string
      description: The type of format to export the image to.
      enum:
        - vmdk
        - qcow2
        - iso
      x-enum-varnames:
        - ExportFormatTypeVMDK
        - ExportFormatTypeQCOW2
        - ExportFormatTypeISO

    ImageExportStatus:
      type: object
      description: ImageExportStatus represents the current status of an ImageExport.
      properties:
        conditions:
          type: array
          description: Current conditions of the ImageExport.
          items:
            $ref: '#/components/schemas/ImageExportCondition'
        manifestDigest:
          type: string
          description: The digest of the exported image manifest for this format.
        lastSeen:
          type: string
          format: date-time
          description: The last time the export was seen (heartbeat).

    ImageExportCondition:
      description: Condition for ImageExport resources.
      allOf:
        - $ref: '../openapi.yaml#/components/schemas/ConditionBase'
        - type: object
          required:
            - type
          properties:
            type:
              $ref: '#/components/schemas/ImageExportConditionType'
    ImageExportConditionType:
      type: string
      description: Type of ImageExport condition.
      enum:
        - Ready
      x-enum-varnames:
        - ImageExportConditionTypeReady
    ImageExportConditionReason:
      type: string
      description: Reason for the ImageExport Ready condition.
      enum:
        - Pending
        - Converting
        - Pushing
        - Completed
        - Failed
      x-enum-varnames:
        - ImageExportConditionReasonPending
        - ImageExportConditionReasonConverting
        - ImageExportConditionReasonPushing
        - ImageExportConditionReasonCompleted
        - ImageExportConditionReasonFailed

    ImageExportFormatPhase:
      type: string
      description: The phase of a single format conversion.
      enum:
        - queued
        - converting
        - pushing
        - complete
        - failed
      x-enum-varnames:
        - ImageExportFormatPhaseQueued
        - ImageExportFormatPhaseConverting
        - ImageExportFormatPhasePushing
        - ImageExportFormatPhaseComplete
        - ImageExportFormatPhaseFailed
    # ImagePipeline schemas
    ImagePipelineRequest:
      type: object
      description: Request to create an ImagePipeline consisting of an ImageBuild and optionally an ImageExport atomically. If imageExport is provided, the server will override its source to reference the created ImageBuild.
      properties:
        imageBuild:
          $ref: '#/components/schemas/ImageBuild'
        imageExport:
          $ref: '#/components/schemas/ImageExport'
      required:
        - imageBuild

    ImagePipelineResponse:
      type: object
      description: Response containing the created ImagePipeline resources (ImageBuild and optionally ImageExport).
      properties:
        imageBuild:
          $ref: '#/components/schemas/ImageBuild'
        imageExport:
          $ref: '#/components/schemas/ImageExport'
      required:
        - imageBuild
