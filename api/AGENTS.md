# API layer – Guidelines for AI assistants

This directory contains the API definitions and generated code for Flight Control. The API is **declarative and modeled after Kubernetes**. Follow these rules to avoid breaking the API contract and codegen pipeline.

## Design: Kubernetes-style API

1. **Adhere to Kubernetes API conventions** – Follow the [Kubernetes API conventions](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md) for types (spec/status, metadata, conditions, object references, naming, validation, etc.).
2. **Use well-known Kubernetes APIs as inspiration** – When designing or extending Flight Control resources, use established Kubernetes APIs (e.g. Pod, Deployment, Service, CustomResourceDefinitions) as reference for structure, field naming, and patterns.

## Do not edit generated files

- **`*.gen.go`** (e.g. `spec.gen.go`, `types.gen.go`, `docs.go`) are generated by [oapi-codegen](https://github.com/oapi-codegen/oapi-codegen).
- **`*.pb.go`** under `api/grpc/` are generated from `.proto` files.
- **Do not** modify these files by hand. Regenerate after changing sources:
  - **REST/OpenAPI:** `make generate` (runs `go generate` excluding `api/grpc`).
  - **gRPC:** `make generate-proto` (runs `go generate ./api/grpc/...`).

## Source of truth

- **OpenAPI specs:** `api/core/v1beta1/openapi.yaml`, `api/core/v1alpha1/openapi.yaml`, `api/agent/v1beta1/openapi.yaml`, `api/imagebuilder/v1alpha1/openapi.yaml`, `api/pam-issuer/v1beta1/openapi.yaml`.
- **Hand-maintained types:** e.g. `api/core/v1beta1/types.go` (non-generated structs and helpers). You may edit these.
- **Codegen config:** Each API version has `*.gen.cfg` (e.g. `spec.gen.cfg`, `types.gen.cfg`) used by oapi-codegen; `//go:generate` in `docs.go` points to the right config and OpenAPI file.
- **gRPC:** Edit `.proto` under `api/grpc/`, then run `make generate-proto`.

## Versioning

- **Core API:** v1alpha1 (legacy) and v1beta1 (current). Prefer v1beta1 for new work.
- **Agent spec:** `api/agent/v1beta1/`.
- **ImageBuilder:** `api/imagebuilder/v1alpha1/`.
- **PAM issuer:** `api/pam-issuer/v1beta1/`.
- Versioning rules and compatibility are documented in [docs/developer/architecture/api-versioning.md](../docs/developer/architecture/api-versioning.md).

## Linting and checks (run before committing)

- OpenAPI specs are linted with Spectral: `make lint-openapi` (see `.spectral.yaml`). When you change OpenAPI or API types, run `make generate` (or `make generate-proto` for gRPC) and `make lint-openapi` before committing.

## Server and client implementation

- Generated server stubs and client code live under `internal/api/server/`, `internal/api/client/`, and `internal/api/convert/` (version conversion). After changing OpenAPI or configs, run `make generate` and update any hand-written server handlers or converters as needed.

## Summary

1. **Design:** Flight Control APIs are declarative and Kubernetes-style; follow the [Kubernetes API conventions](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md) and use well-known Kubernetes APIs as inspiration.
2. Change **OpenAPI YAML** or **hand-maintained types** (e.g. `types.go`), not `*.gen.go`.
3. Run **`make generate`** (or **`make generate-proto`** for gRPC) after edits.
4. Run **`make generate`** and **`make lint-openapi`** before committing when touching OpenAPI or API types.
5. Prefer **v1beta1** for core API changes; respect existing versioning and compatibility docs.
