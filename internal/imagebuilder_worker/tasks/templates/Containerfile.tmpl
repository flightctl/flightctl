FROM {{.RegistryHostname}}/{{.ImageName}}:{{.ImageTag}}

# Add Flight Control repository and install agent
RUN dnf -y config-manager --add-repo https://rpm.flightctl.io/flightctl-epel.repo && \
    dnf install -y flightctl-agent && \
    dnf clean all

# Enable Flight Control agent service
RUN systemctl enable flightctl-agent.service

# Install VM and cloud tools (needed for both early and late binding)
# afterburn provides cloud metadata support, open-vm-tools for VMware guest tools
RUN dnf install -y open-vm-tools && dnf clean all

RUN systemctl enable vmtoolsd.service

{{if .EarlyBinding}}
# Early binding: embed agent config with enrollment credentials
RUN mkdir -p $(dirname {{.AgentConfigDestPath}}) && \
    cat > {{.AgentConfigDestPath}} <<'{{.HeredocDelimiter}}'
{{.AgentConfig}}
{{.HeredocDelimiter}}
RUN chmod 600 {{.AgentConfigDestPath}}
{{else}}
# Late binding: install boot provisioning dependencies
# Ignition is used for QCOW2/ISO formats
RUN dnf install -y ignition afterburn cloud-init && dnf clean all
{{end}}

{{if .HasUserConfig}}
# Create user and configure SSH access
# Note: Using 'wheel' group for sudo access (RHEL/Fedora/CentOS convention)
# This template assumes RHEL/Fedora-based images (uses dnf package manager)
RUN useradd -m -s /bin/bash {{.Username}} && \
    usermod -aG wheel {{.Username}}
# Configure passwordless sudo for the user
RUN echo '{{.Username}} ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/{{.Username}} && \
    chmod 440 /etc/sudoers.d/{{.Username}}
RUN mkdir -p /home/{{.Username}}/.ssh && \
    cat > /home/{{.Username}}/.ssh/authorized_keys <<'{{.PublicKeyDelimiter}}'
{{.Publickey}}
{{.PublicKeyDelimiter}}
RUN chmod 700 /home/{{.Username}}/.ssh && \
    chmod 600 /home/{{.Username}}/.ssh/authorized_keys && \
    chown -R {{.Username}}:{{.Username}} /home/{{.Username}}/.ssh
{{end}}
