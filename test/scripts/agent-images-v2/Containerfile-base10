#
# Multi-stage base image build for flightctl device images.
# Targets:
#   - prebase: bootc base with repos, tooling, users, services (no flightctl RPMs)
#   - base:    final base image starting from prebase and layering flightctl RPMs
#   - base-external: same as base, but uses an external image provided via PREBASE_IMAGE
#

# Global ARG for external prebase image (must be declared before any FROM)
ARG PREBASE_IMAGE

# ---------- Stage: prebase ----------
FROM quay.io/centos-bootc/centos-bootc:stream10 AS prebase

ARG SOURCE_GIT_TAG
ARG SOURCE_GIT_TREE_STATE
ARG SOURCE_GIT_COMMIT

LABEL org.opencontainers.image.source="https://github.com/flightctl/flightctl"
LABEL org.opencontainers.image.version="${SOURCE_GIT_TAG}"
LABEL org.opencontainers.image.revision="${SOURCE_GIT_COMMIT}"

RUN sudo dnf config-manager --set-enabled crb

# Enable EPEL repos
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y epel-release

# Utilities used by tests
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y python-dotenv

# Base services and tooling that don't depend on our RPMs
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y greenboot greenboot-default-health-checks podman-compose && \
    dnf install -y firewalld && \
    systemctl enable firewalld.service && \
    systemctl enable podman.service

# Create test user
RUN useradd -ms /bin/bash user && \
    echo "user:user" | chpasswd && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Create flightctl custom info directory
RUN mkdir -p /usr/lib/flightctl/custom-info.d && \
    chmod 755 /usr/lib/flightctl/custom-info.d

# Add custom system info collectors
RUN echo -e '#!/bin/bash\necho "my site"' > /usr/lib/flightctl/custom-info.d/siteName && \
    echo -e '#!/bin/bash\necho ""' > /usr/lib/flightctl/custom-info.d/emptyValue && \
    echo -e '#!/bin/bash\necho "no-show"' > /usr/lib/flightctl/custom-info.d/keyNotShown && \
    chmod 755 /usr/lib/flightctl/custom-info.d/*


# ---------- Stage: base (from prebase) ----------
FROM prebase AS base

ARG SOURCE_GIT_TAG
ARG SOURCE_GIT_TREE_STATE
ARG SOURCE_GIT_COMMIT

LABEL org.opencontainers.image.source="https://github.com/flightctl/flightctl"
LABEL org.opencontainers.image.version="${SOURCE_GIT_TAG}"
LABEL org.opencontainers.image.revision="${SOURCE_GIT_COMMIT}"

COPY rpms/*.rpm /tmp/rpms/
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    echo "Installing flightctl-agent RPMs" && \
    dnf install -y /tmp/rpms/flightctl-agent-*.rpm /tmp/rpms/flightctl-selinux-*.rpm && \
    systemctl enable flightctl-agent.service && \
    echo "Cleaning up RPMs" && \
    rm -rf /tmp/rpms


# ---------- Stage: base-external (from provided PREBASE_IMAGE) ----------
FROM ${PREBASE_IMAGE} AS base-external

ARG SOURCE_GIT_TAG
ARG SOURCE_GIT_TREE_STATE
ARG SOURCE_GIT_COMMIT

LABEL org.opencontainers.image.source="https://github.com/flightctl/flightctl"
LABEL org.opencontainers.image.version="${SOURCE_GIT_TAG}"
LABEL org.opencontainers.image.revision="${SOURCE_GIT_COMMIT}"

COPY rpms/*.rpm /tmp/rpms/
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    echo "Installing flightctl-agent RPMs" && \
    dnf install -y /tmp/rpms/flightctl-agent-*.rpm /tmp/rpms/flightctl-selinux-*.rpm && \
    systemctl enable flightctl-agent.service && \
    echo "Cleaning up RPMs" && \
    rm -rf /tmp/rpms

# End of multi-stage Containerfile for base images






