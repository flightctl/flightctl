# localhost:5000/flightctl-device:base
#     ${IP}:5000/flightctl-device:base
#
# Base bootc image used for E2E testing and agent-vm with the following features:
#
# * User/pw: user/user
# * Trust on our E2E CA Certificate
# * flightctl-agent configured to talk to our e2e kind flightctl-server
# * greenboot and podman-compose installed

FROM quay.io/centos-bootc/centos-bootc:stream9

COPY bin/e2e-certs/ca.pem /etc/pki/ca-trust/source/anchors/
RUN update-ca-trust

COPY bin/rpm/flightctl-agent-*.rpm /tmp/
RUN dnf install -y /tmp/flightctl-agent-*.rpm && \
    systemctl enable flightctl-agent.service

RUN dnf install -y epel-release epel-next-release
RUN dnf install -y greenboot greenboot-default-health-checks podman-compose
COPY test/scripts/agent-images/greenboot.conf /etc/greenboot.conf

RUN useradd -ms /bin/bash user && \
    echo "user:user" | chpasswd && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

## Add your flightctl configuration and certificates
ADD bin/agent/etc/flightctl/config.yaml /etc/flightctl/
ADD bin/agent/etc/flightctl/certs/* /etc/flightctl/certs/
