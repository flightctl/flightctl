# syntax=docker/dockerfile:1.6
#
# Multi-stage base image build for flightctl device images.
# Targets:
#   - prebase: bootc base with repos, tooling, users, services (no flightctl RPMs)
#   - base:    final base image starting from prebase and layering flightctl RPMs
#

ARG DEVICE_BASE_IMAGE=quay.io/centos-bootc/centos-bootc:stream9
ARG SOURCE_GIT_TAG
ARG SOURCE_GIT_TREE_STATE
ARG SOURCE_GIT_COMMIT
ARG ENABLE_CRB=0
ARG EPEL_NEXT=1
# ---------- Stage: prebase ----------
FROM ${DEVICE_BASE_IMAGE} AS prebase


LABEL org.opencontainers.image.source="https://github.com/flightctl/flightctl"
LABEL org.opencontainers.image.version="${SOURCE_GIT_TAG}"
LABEL org.opencontainers.image.revision="${SOURCE_GIT_COMMIT}"

# Enable CRB (for CentOS Stream 10) if requested
RUN if [ "${ENABLE_CRB}" = "1" ]; then \
      dnf -y install dnf-plugins-core && \
      dnf config-manager --set-enabled crb ; \
    fi

# Enable EPEL repos
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    sh -exc '\
      pkgs="epel-release"; \
      if [ "${EPEL_NEXT}" = "1" ]; then pkgs="$pkgs epel-next-release"; fi; \
      dnf install -y $pkgs \
    '

# Utilities used by tests
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y python-dotenv

# Base services and tooling that don't depend on our RPMs
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y greenboot greenboot-default-health-checks podman-compose && \
    dnf install -y firewalld && \
    systemctl enable firewalld.service && \
    systemctl enable podman.service

# Create test user
RUN useradd -ms /bin/bash user && \
    echo "user:user" | chpasswd && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Create flightctl custom info directory
RUN mkdir -p /usr/lib/flightctl/custom-info.d && \
    chmod 755 /usr/lib/flightctl/custom-info.d

# Add custom system info collectors
RUN echo -e '#!/bin/bash\necho "my site"' > /usr/lib/flightctl/custom-info.d/siteName && \
    echo -e '#!/bin/bash\necho ""' > /usr/lib/flightctl/custom-info.d/emptyValue && \
    echo -e '#!/bin/bash\necho "no-show"' > /usr/lib/flightctl/custom-info.d/keyNotShown && \
    chmod 755 /usr/lib/flightctl/custom-info.d/*


# ---------- Stage: base (from prebase) ----------
FROM prebase AS base

ARG RPMS_FROM=rpms
ARG TRUST_CA_FROM=
ARG AGENT_CONFIG_FROM=
ARG AGENT_CERTS_FROM=

LABEL org.opencontainers.image.source="https://github.com/flightctl/flightctl"
LABEL org.opencontainers.image.version="${SOURCE_GIT_TAG}"
LABEL org.opencontainers.image.revision="${SOURCE_GIT_COMMIT}"

# Install CA trust if provided
RUN --mount=type=bind,source=.,target=/build-context \
    if [ -n "${TRUST_CA_FROM}" ]; then \
      echo "Installing custom CA certificate" && \
      cp "/build-context/${TRUST_CA_FROM}" /etc/pki/ca-trust/source/anchors/ && \
      update-ca-trust; \
    fi


# Install agent config if provided
RUN --mount=type=bind,source=.,target=/build-context \
    if [ -n "${AGENT_CONFIG_FROM}" ]; then \
      echo "Installing agent config" && \
      mkdir -p /etc/flightctl && \
      cp "/build-context/${AGENT_CONFIG_FROM}" /etc/flightctl/config.yaml; \
    fi

# Install agent certificates if provided
RUN --mount=type=bind,source=.,target=/build-context \
    if [ -n "${AGENT_CERTS_FROM}" ]; then \
      echo "Installing agent certificates" && \
      mkdir -p /etc/flightctl/certs && \
      cp "/build-context/${AGENT_CERTS_FROM}"/* /etc/flightctl/certs/; \
    fi



COPY ${RPMS_FROM}/flightctl-agent-*.rpm /tmp/rpms/
COPY ${RPMS_FROM}/flightctl-selinux-*.rpm /tmp/rpms/

RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    echo "Installing flightctl-agent RPMs" && \
    dnf install -y /tmp/rpms/flightctl-agent-*.rpm /tmp/rpms/flightctl-selinux-*.rpm && \
    systemctl enable flightctl-agent.service && \
    echo "Cleaning up RPMs" && \
    rm -rf /tmp/rpms