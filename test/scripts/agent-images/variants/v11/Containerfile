# quay.io/flightctl/flightctl-device:v11
#
# BROKEN bootc image for testing greenboot rollback.
# Uses a systemd drop-in to override the agent's ExecStart command.
#
# When the device boots into this image:
# 1. flightctl-agent.service starts
# 2. Systemd reads the drop-in and runs /bin/false instead of the real agent
# 3. /bin/false exits immediately with code 1
# 4. No READY=1 is sent to systemd
# 5. Service fails to start
# 6. Greenboot health check detects the failure
# 7. After retries, greenboot triggers OS rollback
# 8. Device reboots back to previous deployment

ARG BASE_IMAGE=quay.io/flightctl/flightctl-device:base

FROM ${BASE_IMAGE}

# Create drop-in directory for flightctl-agent.service
RUN mkdir -p /etc/systemd/system/flightctl-agent.service.d

# Copy the drop-in that overrides ExecStart to /bin/false
COPY --from=variant-context 99-break-agent.conf /etc/systemd/system/flightctl-agent.service.d/

# Speed up greenboot rollback for E2E testing (shell greenboot 0.15.x):
# - Reduce boot attempts from 3 to 1 (saves ~6 minutes of waiting)
# Note: greenboot-rs (0.16.x) may ignore this config file
COPY --from=variant-context greenboot.conf /etc/greenboot/greenboot.conf
