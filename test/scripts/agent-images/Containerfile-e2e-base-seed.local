# localhost:5000/flightctl-device-seed:base
#
# Seed base bootc image for E2E testing. This intentionally omits
# flightctl agent enrollment config, device certs, and registries.conf.
# Those are applied later in a lightweight finalize step.

FROM quay.io/centos-bootc/centos-bootc:stream9

ARG RPM_COPR=
ARG RPM_PACKAGE=flightctl-agent
ARG BREW_BUILD_URL=

# Trust the E2E CA so agents can later connect once config is injected
COPY bin/e2e-certs/pki/CA/ca.pem /etc/pki/ca-trust/source/anchors/
RUN update-ca-trust

# Copy entire bin directory to /tmp for build process
COPY bin/ /tmp/bin/

RUN if [[ -n "$BREW_BUILD_URL" ]]; then \
        echo "Installing RPMs from brew URL: ${BREW_BUILD_URL}"; \
        dnf install -y /tmp/bin/brew-rpm/flightctl-agent-*.rpm /tmp/bin/brew-rpm/flightctl-selinux-*.rpm /tmp/bin/brew-rpm/flightctl-debuginfo-*.rpm; \
    elif [[ -n "$RPM_COPR" ]]; then \
        echo "Installing RPMs from COPR repository: ${RPM_COPR}" && \
        dnf copr -y enable ${RPM_COPR} && \
        dnf install -y ${RPM_PACKAGE}; \
    else \
        echo "Installing local RPMs" && \
        dnf install -y /tmp/bin/rpm/flightctl-agent-*.rpm /tmp/bin/rpm/flightctl-selinux-*.rpm; \
    fi && \
    systemctl enable flightctl-agent.service && \
    echo "Cleaning up build files from /tmp/bin" && \
    rm -rf /tmp/bin

RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y epel-release epel-next-release

RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y python-dotenv

RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y greenboot greenboot-default-health-checks podman-compose && \
    dnf install -y firewalld && \
    systemctl enable firewalld.service && \
    systemctl enable podman.service

RUN useradd -ms /bin/bash user && \
    echo "user:user" | chpasswd && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# NOTE: No agent config/certs and no registries.conf here. Those are applied
# later by a tiny finalize layer.


