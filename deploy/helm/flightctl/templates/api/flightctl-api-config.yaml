{{- if $.Values.api.enabled }}
{{- $serviceMethod := include "flightctl.getServiceExposeMethod" . }}
{{- $baseDomain := include "flightctl.getBaseDomain" . }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: flightctl-api-config
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "common.labels.standard" $ | nindent 4 }}
    app.kubernetes.io/component: api
data:
  config.yaml: |-
    database:
        hostname: {{ $.Values.postgresql.hostname | default (printf "%s-postgresql" $.Release.Name) }}
        type: pgsql
        port: {{ $.Values.postgresql.port }}
        name: {{ $.Values.postgresql.dbName }}
    service:
        address: :3443
        agentEndpointAddress: :7443
        httpReadTimeout: {{ $.Values.api.httpReadTimeout | default "5m" | quote }}
        httpReadHeaderTimeout: {{ $.Values.api.httpReadHeaderTimeout | default "5m" | quote }}
        httpWriteTimeout: {{ $.Values.api.httpWriteTimeout | default "5m" | quote }}
        httpMaxNumHeaders: {{ $.Values.api.httpMaxNumHeaders | default 32 }}
        httpMaxHeaderBytes: {{ $.Values.api.httpMaxHeaderBytes | default 33010 }}
        httpMaxUrlLength: {{ $.Values.api.httpMaxUrlLength | default 2000 }}
        httpMaxRequestSize: {{ $.Values.api.httpMaxRequestSize | default 53137200 }}
        {{- if eq $serviceMethod "nodePort" }}
        baseUrl: {{ printf "https://api.%s:%d/" $baseDomain (int $.Values.global.nodePorts.api) }}
        baseAgentEndpointUrl: {{ printf "https://agent-api.%s:%d/" $baseDomain (int $.Values.global.nodePorts.agent) }}
        {{- else if and (eq $serviceMethod "gateway") (not (eq (int .Values.global.gatewayPorts.tls) 443)) }}
        baseUrl: {{ printf "https://api.%s:%d/" $baseDomain (int $.Values.global.gatewayPorts.tls) }}
        baseAgentEndpointUrl: {{ printf "https://agent-api.%s:%s/" $baseDomain (int $.Values.global.gatewayPorts.tls) }}
        {{- else }}
        baseUrl: {{ printf "https://api.%s/" $baseDomain }}
        baseAgentEndpointUrl: {{ printf "https://agent-api.%s/" $baseDomain }}
        {{- end }}
        {{- if $.Values.ui.baseURL }}
        baseUIUrl: {{ $.Values.ui.baseURL }}
        {{- else }}
        baseUIUrl: {{ include "flightctl.getUIUrl" . }}
        {{- end }}
        altNames:
          - {{ printf "api.%s" $baseDomain }}
          - {{ printf "agent-api.%s" $baseDomain }}
          - flightctl-api
          - {{ printf "flightctl-api.%s" $.Release.Namespace }}
          - {{ printf "flightctl-api.%s.svc.cluster.local" $.Release.Namespace }}
    kv:
        hostname: {{ $.Values.redis.hostname | default (printf "%s-redis-master" $.Release.Name) }}
        port: {{ $.Values.redis.port }}
    {{- if not (eq .Values.global.auth.type "none")  }}
    auth:
        insecureSkipTlsVerify: {{ $.Values.global.auth.insecureSkipTlsVerify }}
        caCert: {{ $.Values.global.auth.caCert }}
        {{- if or (eq $.Values.global.target "acm") (eq $.Values.global.auth.type "k8s")  }}
        k8s:
            apiUrl: {{ $.Values.global.auth.k8s.apiUrl }}
            externalOpenShiftApiUrl: {{ include "flightctl.getOpenShiftAPIUrl" . }}
            rbacNs: {{ $.Values.global.auth.k8s.rbacNs | default $.Release.Namespace }}
        {{- else if eq $.Values.global.auth.type "aap"}}
        aap:
          apiUrl: {{ $.Values.global.auth.aap.apiUrl }}
          externalApiUrl: {{ $.Values.global.auth.aap.externalApiUrl }}
        {{- else }}
        oidc:
            oidcAuthority: {{ $.Values.global.auth.oidc.oidcAuthority }}
            externalOidcAuthority: {{ include "flightctl.getOidcAuthorityUrl" . }}
        {{- end }}
    {{- end }}
    {{- if $.Values.prometheus.enabled }}
    prometheus:
        address: ":15690"
        sloMax: 4.0
        apiLatencyBins: [0.000001, 0.00001, 0.0001, 0.001, 0.01, 0.1, 1]
    {{- end }}
{{ end }}
