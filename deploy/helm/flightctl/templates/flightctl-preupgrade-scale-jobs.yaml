{{- /* Determine whether to render the pre-upgrade scale job */ -}}
{{- $allDeployments := default (list) .Values.upgradeHooks.scaleDown.deployments -}}
{{- $condition := default "chart" .Values.upgradeHooks.scaleDown.condition -}}
{{- $deploymentsToScale := list -}}

{{- if gt (len $allDeployments) 0 -}}
  {{- if eq $condition "always" -}}
    {{- $deploymentsToScale = $allDeployments -}}
  {{- else if eq $condition "never" -}}
    {{- /* leave empty */ -}}
  {{- else -}}
    {{- /* Default: "chart" â€” scale only when helm.sh/chart changed */ -}}
    {{- $ns := default .Release.Namespace .Values.global.internalNamespace -}}
    {{- $currentChart := printf "%s-%s" .Chart.Name (.Chart.Version | replace "+" "_") -}}
    {{- range $d := $allDeployments -}}
      {{- $depObj := lookup "apps/v1" "Deployment" $ns $d -}}
      {{- $existingChart := dig "metadata" "labels" "helm.sh/chart" "" $depObj -}}
      {{- if ne $existingChart $currentChart -}}
        {{- $deploymentsToScale = append $deploymentsToScale $d -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if gt (len $deploymentsToScale) 0 }}
---
# ServiceAccount and RBAC for pre-upgrade scaling
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flightctl-upgrade
  namespace: {{ default .Release.Namespace .Values.global.internalNamespace }}
  labels:
    {{- include "flightctl.standardLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "-25"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded

---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flightctl-upgrade
  namespace: {{ default .Release.Namespace .Values.global.internalNamespace }}
  labels:
    {{- include "flightctl.standardLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "-24"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
  - apiGroups: ["apps"]
    resources: ["deployments", "deployments/scale"]
    verbs: ["get", "list", "patch", "update", "watch"]

---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: flightctl-upgrade
  namespace: {{ default .Release.Namespace .Values.global.internalNamespace }}
  labels:
    {{- include "flightctl.standardLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "-23"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
subjects:
  - kind: ServiceAccount
    name: flightctl-upgrade
    namespace: {{ default .Release.Namespace .Values.global.internalNamespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: flightctl-upgrade

---
apiVersion: batch/v1
kind: Job
metadata:
  name: flightctl-preupgrade-scale-to-zero
  namespace: {{ default .Release.Namespace .Values.global.internalNamespace }}
  labels:
    {{- include "flightctl.standardLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "-20"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  backoffLimit: 1
  template:
    metadata:
      labels:
        flightctl.service: flightctl-preupgrade
        {{- include "flightctl.standardLabels" . | nindent 8 }}
    spec:
      restartPolicy: Never
      serviceAccountName: flightctl-upgrade
      {{- if .Values.global.imagePullSecretName }}
      imagePullSecrets:
        - name: {{ .Values.global.imagePullSecretName }}
      {{- end }}
      containers:
        - name: scaler
          image: {{ .Values.clusterCli.image.image }}:{{ .Values.clusterCli.image.tag }}
          imagePullPolicy: {{ default .Values.global.imagePullPolicy .Values.clusterCli.image.pullPolicy }}
          command: ["/bin/sh","-c"]
          args:
            - |
              set -euo pipefail
              NAMESPACE={{ default .Release.Namespace .Values.global.internalNamespace }}
              TIMEOUT={{ default 120 .Values.upgradeHooks.scaleDown.timeoutSeconds }}
              echo "=== PRE-UPGRADE SCALE-DOWN DEBUG ==="
              echo "Namespace: ${NAMESPACE}"
              echo "Timeout: ${TIMEOUT}s"
              echo "Deployments to scale: {{- range $idx, $d := $deploymentsToScale -}}{{ if $idx }} {{ end }}{{ $d }}{{- end }}"

              # Show initial cluster state
              echo ""
              echo "=== INITIAL STATE ==="
              oc get deployments -n "${NAMESPACE}" -o wide || echo "Failed to get deployments"
              oc get pods -n "${NAMESPACE}" -o wide || echo "Failed to get pods"

              DEPLOYMENTS="{{- range $idx, $d := $deploymentsToScale -}}{{ if $idx }} {{ end }}{{ $d }}{{- end }}"
              for dep in ${DEPLOYMENTS}; do
                echo ""
                echo "=== PROCESSING ${dep} ==="
                echo "Checking if deployment ${dep} exists..."

                if oc get deployment ${dep} -n "${NAMESPACE}" >/dev/null 2>&1; then
                  # Show initial state
                  echo "Initial state of ${dep}:"
                  oc get deployment ${dep} -n "${NAMESPACE}" -o wide
                  oc get pods -n "${NAMESPACE}" -l app=${dep} || echo "No pods with label app=${dep}"

                  echo "Scaling ${dep} to 0 replicas..."
                  if oc scale deployment/${dep} -n "${NAMESPACE}" --replicas=0; then
                    echo "Scale command succeeded, waiting for rollout..."

                    # Monitor with detailed logging
                    start_time=$(date +%s)
                    while true; do
                      current_time=$(date +%s)
                      elapsed=$((current_time - start_time))

                      if [ $elapsed -ge $TIMEOUT ]; then
                        echo "TIMEOUT: ${dep} did not scale down in ${TIMEOUT}s"
                        break
                      fi

                      # Get current status
                      status=$(oc get deployment ${dep} -n "${NAMESPACE}" -o jsonpath='{.status.replicas},{.status.readyReplicas},{.status.updatedReplicas},{.status.availableReplicas}' 2>/dev/null || echo ",,,")
                      set -- $(printf "%s" "$status" | tr ',' ' ')
                      replicas=${1:-0}
                      ready=${2:-0}
                      updated=${3:-0}
                      available=${4:-0}

                      echo "[${elapsed}s] ${dep}: replicas=${replicas}, ready=${ready}, updated=${updated}, available=${available}"

                      # Check if fully scaled down
                      if [ "${replicas:-0}" = "0" ] && [ "${ready:-0}" = "0" ] && [ "${available:-0}" = "0" ]; then
                        echo "SUCCESS: ${dep} fully scaled down"
                        break
                      fi

                      # Show pod states if still scaling
                      if [ $((elapsed % 20)) -eq 0 ]; then
                        echo "Current pods for ${dep}:"
                        oc get pods -n "${NAMESPACE}" -l app=${dep} -o wide || echo "No pods"
                        echo "Recent events:"
                        oc get events -n "${NAMESPACE}" --field-selector involvedObject.name=${dep} --sort-by='.lastTimestamp' | tail -3 || echo "No events"
                      fi

                      sleep 2
                    done

                    # Final status check
                    echo "Final status of ${dep}:"
                    oc get deployment ${dep} -n "${NAMESPACE}" -o wide || echo "Failed to get deployment"
                    oc get pods -n "${NAMESPACE}" -l app=${dep} -o wide || echo "No pods"

                  else
                    echo "ERROR: Failed to scale ${dep}"
                    oc get deployment ${dep} -n "${NAMESPACE}" -o yaml || echo "Failed to get deployment details"
                  fi
                else
                  echo "Deployment ${dep} does not exist, skipping..."
                fi
              done

              echo ""
              echo "=== FINAL STATE ==="
              oc get deployments -n "${NAMESPACE}" -o wide || echo "Failed to get deployments"
              oc get pods -n "${NAMESPACE}" -o wide || echo "Failed to get pods"
              echo "=== SCALE-DOWN COMPLETE ==="
{{- end }}


