apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-connection-test"
  labels:
    {{- include "flightctl.standardLabels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  {{- if .Values.global.imagePullSecretName }}
  imagePullSecrets:
    - name: {{ .Values.global.imagePullSecretName }}
  {{- end }}
  containers:
    - name: "{{ .Release.Name }}-connection-test"
      image: "registry.access.redhat.com/ubi9/ubi-minimal:9.7-1763362218"
      imagePullPolicy: IfNotPresent
      command:
        - '/bin/bash'
        - '-exc'
        - >
          echo "Testing connectivity to Flight Control API...";
          curl -sfk https://flightctl-api:3443/api/v1/auth/config &&
          echo "✅ Connection successful" ||
          (echo "❌ Connection failed" && exit 1)
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop: ["ALL"]
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
  restartPolicy: Never