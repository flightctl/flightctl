{{- if and (eq .Values.db.type "builtin") (empty .Values.db.builtin.migrationUserSecretName) }}
{{- $namespaces := list .Release.Namespace }}
{{- $context := . }}
{{- if and .Values.global.internalNamespace (ne .Values.global.internalNamespace .Release.Namespace) }}
{{- $namespaces = append $namespaces .Values.global.internalNamespace }}
{{- end }}
{{- $migrationPassword := "" }}
{{- range $ns := $namespaces }}
  {{- if not $migrationPassword }}
    {{- $existingSecret := (lookup "v1" "Secret" $ns "flightctl-db-migration-secret") }}
    {{- if $existingSecret }}
      {{- if and (hasKey $existingSecret "data") (hasKey $existingSecret.data "migrationPassword") }}
        {{- $migrationPassword = (index $existingSecret.data "migrationPassword") }}
      {{- else }}
        {{- fail "flightctl-db-migration-secret is missing data.migrationPassword â€“ delete it or add the key." }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- if not $migrationPassword }}
  {{- $migrationPassword = (include "flightctl.generatePassword" .) }}
{{- end }}
{{- range $ns := $namespaces }}
---
apiVersion: v1
kind: Secret
metadata:
  name: flightctl-db-migration-secret
  namespace: {{ $ns }}
  labels:
    {{- include "flightctl.standardLabels" $context | nindent 4 }}
    flightctl.service: flightctl-db-migration
    security.level: schema-privilege
type: Opaque
data:
  # Migration user credentials for schema changes only
  migrationUser: {{ "flightctl_migrator" | b64enc }}
  migrationPassword: {{ $migrationPassword }}
{{- end }}
{{- end }}
