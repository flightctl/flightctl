{{- if eq (include "flightctl.getEffectiveAuthType" .) "openshift" }}
{{- if .Values.global.generateSecrets }}
{{- $secretName := printf "%s-secret" (include "flightctl.getOpenShiftOAuthClientId" .) }}
{{- $existingSecret := (lookup "v1" "Secret" "openshift-config" $secretName) }}
{{- $clientSecret := "" }}
{{- if $existingSecret }}
  {{- if and (hasKey $existingSecret "data") (hasKey $existingSecret.data "clientSecret") }}
    {{- $clientSecret = (index $existingSecret.data "clientSecret") }}
  {{- else }}
    {{- fail (printf "Secret %s is missing data.clientSecret â€“ delete it or add the key." $secretName) }}
  {{- end }}
{{- else }}
  {{- $clientSecret = (randAlphaNum 32 | b64enc) }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: openshift-config
  labels:
    {{- include "flightctl.standardLabels" . | nindent 4 }}
    app: flightctl
    component: oauth-client
type: Opaque
data:
  clientSecret: {{ if .Values.global.auth.openshift.clientSecret }}{{ .Values.global.auth.openshift.clientSecret | b64enc }}{{ else }}{{ $clientSecret }}{{ end }}
{{- end }}
{{- end }}

