{{- if and .Values.otelCollector.enabled .Values.otelCollector.prometheus.enabled (ne .Values.global.target "acm") }}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    flightctl.service: flightctl-prometheus
  name: flightctl-prometheus
  namespace: {{ .Release.Namespace }}
spec:
  {{- if eq .Values.global.exposeServicesMethod "nodePort" }}
  type: NodePort
  {{- else }}
  type: ClusterIP
  {{- end }}
  ports:
    - name: "flightctl-prometheus"
      port: 9090
      targetPort: 9090
      {{- if and (eq .Values.global.exposeServicesMethod "nodePort") .Values.global.nodePorts.prometheus }}
      nodePort: {{ .Values.global.nodePorts.prometheus }}
      {{- end }}
  selector:
    flightctl.service: flightctl-prometheus

{{- if eq .Values.global.exposeServicesMethod "route" }}
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: flightctl-prometheus
  namespace: {{ .Release.Namespace }}
  labels:
    flightctl.service: flightctl-prometheus
spec:
  host: prometheus{{ if .Values.global.baseDomain }}.{{ .Values.global.baseDomain }}{{ end }}
  port:
    targetPort: "flightctl-prometheus"
  to:
    kind: Service
    name: flightctl-prometheus
    weight: 100
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
{{- end }}

{{- if eq .Values.global.exposeServicesMethod "gateway" }}
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: flightctl-prometheus
  namespace: {{ .Release.Namespace }}
  labels:
    flightctl.service: flightctl-prometheus
spec:
  parentRefs:
    - name: flightctl-gateway
      namespace: {{ .Release.Namespace }}
  hostnames:
    - "prometheus{{ if .Values.global.baseDomain }}.{{ .Values.global.baseDomain }}{{ end }}"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: flightctl-prometheus
          port: 9090
{{- end }}
{{- end }} 